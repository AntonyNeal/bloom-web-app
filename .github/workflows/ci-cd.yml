# LIFE PSYCHOLOGY UNIFIED CI/CD WORKFLOW
# Combined Application Deployment + Database Migrations
# Last updated: 2025-12-06
#
# APPLICATIONS:
# 1. Bloom Portal (apps/bloom) + Bloom API (api/)
# 2. Website (apps/website) + Website API (apps/website/functions)
# 3. Halaxy DB Realtime Sync Service (api/src/services/halaxy/)
# 4. Database Migrations (db/migrations)
#
# ENVIRONMENTS:
# - Development (develop branch)
# - Staging (staging branch)
# - Production (main branch)
#
# TRIGGERS:
# - Auto-deploy on push to main/staging/develop
# - Smart change detection per app/db

name: CI/CD Pipeline

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
      - develop   # Development
  pull_request:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      deploy_bloom:
        description: 'Deploy Bloom Portal'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy Website'
        required: false
        type: boolean
        default: true
      deploy_apis:
        description: 'Deploy APIs'
        required: false
        type: boolean
        default: true
      run_migrations:
        description: 'Run Database Migrations'
        required: false
        type: boolean
        default: true
      deploy_halaxy_sync:
        description: 'Deploy Halaxy Sync Service'
        required: false
        type: boolean
        default: true
      dry_run_migrations:
        description: 'Dry run migrations (preview only)'
        required: false
        type: boolean
        default: false

# Ensure only one workflow runs per branch at a time
# Cancel any in-progress runs when a new push happens
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 1: SETUP & ENVIRONMENT CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Environment Configuration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  determine-environment:
    name: ðŸŒ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should-deploy: ${{ steps.config.outputs.should_deploy }}
      is-staging-validation: ${{ steps.config.outputs.is_staging_validation }}
      db-environment: ${{ steps.config.outputs.db_environment }}
      # Bloom Portal
      bloom-frontend-app: ${{ steps.config.outputs.bloom_frontend_app }}
      bloom-api-app: ${{ steps.config.outputs.bloom_api_app }}
      bloom-frontend-secret: ${{ steps.config.outputs.bloom_frontend_secret }}
      bloom-api-secret: ${{ steps.config.outputs.bloom_api_secret }}
      bloom-api-url: ${{ steps.config.outputs.bloom_api_url }}
      # Website
      website-frontend-app: ${{ steps.config.outputs.website_frontend_app }}
      website-api-app: ${{ steps.config.outputs.website_api_app }}
      website-frontend-secret: ${{ steps.config.outputs.website_frontend_secret }}
      website-api-secret: ${{ steps.config.outputs.website_api_secret }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          REF="${{ github.ref }}"
          MANUAL_ENV="${{ github.event.inputs.environment }}"

          echo "ðŸ“ Branch/Ref: $REF"
          echo "ðŸŽ¯ Manual Override: $MANUAL_ENV"

          # Use manual input if workflow_dispatch, otherwise use branch
          if [ -n "$MANUAL_ENV" ]; then
            ENV="$MANUAL_ENV"
          else
            case "$REF" in
              refs/heads/main)
                ENV="production"
                ;;
              refs/heads/staging)
                ENV="staging"
                ;;
              refs/heads/develop)
                ENV="development"
                ;;
              refs/pull/*)
                ENV="preview"
                ;;
              *)
                ENV="preview"
                ;;
            esac
          fi

          # Database environment mapping (staging uses dev DBs)
          IS_STAGING_VALIDATION="false"
          case "$ENV" in
            production)
              DB_ENV="prod"
              ;;
            staging)
              DB_ENV="dev"
              IS_STAGING_VALIDATION="true"
              ;;
            *)
              DB_ENV="dev"
              ;;
          esac

          # Set resource names based on environment
          case "$ENV" in
            production)
              BLOOM_FRONTEND_APP="lpa-bloom-prod"
              BLOOM_API_APP="bloom-platform-functions-v2"
              BLOOM_API_URL="https://bloom-platform-functions-v2.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD"
              BLOOM_API_SECRET="BLOOM_PROD_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-prod"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            staging)
              BLOOM_FRONTEND_APP="lpa-bloom-staging"
              BLOOM_API_APP="bloom-functions-staging-new"
              BLOOM_API_URL="https://bloom-functions-staging-new.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING"
              BLOOM_API_SECRET="BLOOM_STAGING_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-staging"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            development)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV"
              BLOOM_API_SECRET="BLOOM_DEV_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            preview)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET=""
              BLOOM_API_SECRET=""
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET=""
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="false"
              ;;
          esac

          # Output configuration
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_staging_validation=$IS_STAGING_VALIDATION" >> $GITHUB_OUTPUT
          echo "db_environment=$DB_ENV" >> $GITHUB_OUTPUT
          
          # Bloom Portal
          echo "bloom_frontend_app=$BLOOM_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_app=$BLOOM_API_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_url=$BLOOM_API_URL" >> $GITHUB_OUTPUT
          echo "bloom_frontend_secret=$BLOOM_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "bloom_api_secret=$BLOOM_API_SECRET" >> $GITHUB_OUTPUT
          
          # Website
          echo "website_frontend_app=$WEBSITE_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "website_api_app=$WEBSITE_API_APP" >> $GITHUB_OUTPUT
          echo "website_frontend_secret=$WEBSITE_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "website_api_secret=$WEBSITE_API_SECRET" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ENVIRONMENT CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Environment:         $ENV"
          echo "ðŸ—„ï¸ DB Environment:      $DB_ENV"
          echo "ðŸš€ Should Deploy:       $SHOULD_DEPLOY"
          echo "ðŸ”„ Staging Validation:  $IS_STAGING_VALIDATION"
          echo ""
          echo "ðŸŒ¸ Bloom Frontend:      $BLOOM_FRONTEND_APP"
          echo "ðŸ”Œ Bloom API:           $BLOOM_API_APP"
          echo "ðŸŒ Website Frontend:    $WEBSITE_FRONTEND_APP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect Changes (Always deploy everything on push)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      bloom-frontend: 'true'
      bloom-api: 'true'
      halaxy-worker: 'true'
      website-frontend: 'true'
      website-api: 'true'
      database: 'true'
    steps:
      - name: Always Deploy Everything
        run: |
          echo "ðŸš€ Always deploy all components on push"
          echo "   bloom-frontend: true"
          echo "   bloom-api: true"
          echo "   halaxy-worker: true"
          echo "   website-frontend: true"
          echo "   website-api: true"
          echo "   database: true"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Quality Checks (Run in Parallel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lint:
    name: ðŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint

  type-check:
    name: ðŸ” Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Type Check
        run: npx tsc --noEmit

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 2: DATABASE MIGRATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Validate Migrations
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  validate-migrations:
    name: âœ… Validate Migrations
    runs-on: ubuntu-latest
    needs: [detect-changes, determine-environment]
    if: |
      needs.detect-changes.outputs.database == 'true' ||
      github.event.inputs.run_migrations == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Validate Migration Scripts
        run: |
          echo "ðŸ” Validating migration scripts..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              echo "   Checking: $file"
              if grep -qi "DROP DATABASE" "$file"; then
                echo "âŒ Error: DROP DATABASE found in $file"
                exit 1
              fi
              if grep -qi "TRUNCATE.*applications" "$file" && [ "${{ needs.determine-environment.outputs.db-environment }}" == "prod" ]; then
                echo "âš ï¸ Warning: TRUNCATE on applications table in production"
              fi
            fi
          done
          
          echo "âœ… All migration scripts validated"

      - name: Check Migration Naming Convention
        run: |
          echo "ðŸ” Checking migration naming conventions..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if ! [[ "$filename" =~ ^V[0-9]+[a-z]?__[a-z0-9_]+\.sql$ ]]; then
                echo "âš ï¸ Warning: $filename doesn't follow naming convention V{version}__{description}.sql"
              fi
            fi
          done
          
          echo "âœ… Naming convention check complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Run Migrations
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  run-migrations:
    name: ðŸ—„ï¸ Run Migrations (${{ needs.determine-environment.outputs.db-environment }})
    runs-on: ubuntu-latest
    needs: [detect-changes, determine-environment, validate-migrations, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.database == 'true' || github.event.inputs.run_migrations == 'true') &&
      needs.validate-migrations.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.db-environment == 'prod' && 'production' || needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Connection Strings from Key Vault
        id: secrets
        run: |
          ENV_SUFFIX="${{ needs.determine-environment.outputs.db-environment == 'prod' && 'PROD' || 'DEV' }}"
          
          # Use the actual Key Vault name (includes random suffix from Bicep deployment)
          KV_NAME="lpa-kv-dev-i3u6u6psuu75o"
          
          SQL_CONN=$(az keyvault secret show \
            --name "SQL-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SQL_CONN" ]; then
            echo "SQL_CONNECTION_STRING=$SQL_CONN" >> $GITHUB_ENV
          fi
          
          COSMOS_CONN=$(az keyvault secret show \
            --name "COSMOS-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$COSMOS_CONN" ]; then
            echo "DBVC_COSMOS_CONNECTION_STRING=$COSMOS_CONN" >> $GITHUB_ENV
          fi

      - name: Run Migrations
        id: migrate
        working-directory: api
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
          DRY_RUN: ${{ github.event.inputs.dry_run_migrations || github.event_name == 'pull_request' }}
        run: |
          echo "ðŸš€ Building database schema for ${{ needs.determine-environment.outputs.db-environment }}..."
          
          # Build schema from single source of truth
          node build-schema.js
        continue-on-error: ${{ github.event.inputs.dry_run_migrations == 'true' || github.event_name == 'pull_request' }}

      - name: Extended Validation (Staging)
        if: |
          success() && 
          needs.determine-environment.outputs.is-staging-validation == 'true' && 
          github.event.inputs.dry_run_migrations != 'true' &&
          github.event_name != 'pull_request'
        working-directory: api
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
        run: |
          echo "ðŸ”¬ Running extended validation tests (staging branch - second pass)..."
          echo "ðŸ“‹ This validates migrations are safe to promote to production"
          
          # Simple validation - check schema_versions table
          cat > extended-validation.js << 'EOF'
          const sql = require('mssql');
          
          async function main() {
            let pool;
            try {
              pool = await sql.connect(process.env.SQL_CONNECTION_STRING);
              
              console.log('\nðŸ”¬ EXTENDED VALIDATION SUITE');
              console.log('â”'.repeat(50));
              
              // Check schema_versions table
              const result = await pool.request().query(`
                SELECT version, description, applied_at, applied_by 
                FROM schema_versions 
                ORDER BY applied_at DESC
              `);
              
              console.log(`\nðŸ“‹ Applied migrations: ${result.recordset.length}`);
              for (const row of result.recordset.slice(0, 5)) {
                console.log(`   âœ… ${row.version}: ${row.description}`);
              }
              
              // Simple schema check
              const tablesResult = await pool.request().query(`
                SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES 
                WHERE TABLE_TYPE = 'BASE TABLE'
              `);
              console.log(`\nðŸ“Š Tables in database: ${tablesResult.recordset.length}`);
              
              console.log('\n' + 'â”'.repeat(50));
              console.log('âœ… EXTENDED VALIDATION PASSED');
              
              await pool.close();
              process.exit(0);
            } catch (error) {
              console.error('âŒ Extended validation error:', error.message);
              if (pool) await pool.close();
              process.exit(1);
            }
          }
          
          main();
          EOF
          
          node extended-validation.js

      - name: Migration Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.migrate.outcome }}' === 'success';
            const environment = '${{ needs.determine-environment.outputs.db-environment }}';
            const dryRun = '${{ github.event.inputs.dry_run_migrations }}' === 'true' || '${{ github.event_name }}' === 'pull_request';
            
            const summary = `## ðŸ—ƒï¸ Database Migration Summary
            
            | Property | Value |
            |----------|-------|
            | Environment | \`${environment}\` |
            | Dry Run | ${dryRun ? 'âœ… Yes' : 'âŒ No'} |
            | Status | ${success ? 'âœ… Success' : 'âŒ Failed'} |
            | Commit | \`${context.sha.substring(0, 7)}\` |
            `;
            
            await core.summary.addRaw(summary).write();

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Rollback on Failure (Production only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  rollback-migrations:
    name: ðŸ”„ Rollback Migrations (if needed)
    runs-on: ubuntu-latest
    needs: [determine-environment, run-migrations]
    if: |
      failure() && 
      needs.determine-environment.outputs.db-environment == 'prod' && 
      github.event.inputs.dry_run_migrations != 'true' &&
      github.event_name != 'pull_request'
    environment: production
    steps:
      - name: Rollback Alert
        run: |
          echo "âš ï¸ Production migration failed!"
          echo "Manual rollback may be required."

      - name: Create Issue for Failed Migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Migration Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Migration Failure
              
              A database migration failed in production.
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit:** ${context.sha}
              
              /cc @${context.actor}
              `,
              labels: ['bug', 'production', 'database', 'urgent']
            });

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 3: BUILD APPLICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-frontend:
    name: ðŸŒ¸ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Bloom Application
        env:
          MODE: ${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'development' }}
          VITE_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
        run: |
          echo "ðŸŒ¸ Building Bloom Frontend..."
          echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          npm run build:bloom -- --mode $MODE
          echo "âœ… Build complete"

      - name: Verify Build Output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ dist/index.html not found!"
            exit 1
          fi
          echo "âœ… Build verified"

      - name: Package Artifacts
        run: |
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            bloom-frontend-dist.tar.gz
            bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-website-frontend:
    name: ðŸŒ Build Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Website Dependencies
        working-directory: apps/website
        run: npm install

      - name: Build Website Application
        run: |
          echo "ðŸŒ Building Website Frontend..."
          npm run build:website
          echo "âœ… Build complete"
        env:
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_FUNCTIONS_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
          VITE_AZURE_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
          VITE_AVAILABILITY_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/halaxy/availability
          VITE_HALAXY_BOOKING_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/create-halaxy-booking

      - name: Verify Build Output
        run: |
          if [ ! -f "apps/website/dist/index.html" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          echo "âœ… Build verified"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/dist/
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-api:
    name: ðŸ”Œ Build Bloom API (incl. Halaxy Sync)
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install API Dependencies
        working-directory: ./api
        run: npm ci

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "ðŸ”Œ Building Bloom API..."
          npm run build
          echo "âœ… API build complete"

      - name: Verify Halaxy Sync Service
        working-directory: ./api
        run: |
          echo "ðŸ”„ Verifying Halaxy Sync Service compilation..."
          if [ -f "dist/services/halaxy/sync-service.js" ]; then
            echo "âœ… Halaxy Sync Service compiled successfully"
          else
            echo "âŒ Halaxy Sync Service not found in build output!"
            exit 1
          fi
          
          # Verify all Halaxy service files
          for file in client index transformers token-manager types; do
            if [ -f "dist/services/halaxy/${file}.js" ]; then
              echo "  âœ“ halaxy/${file}.js"
            else
              echo "  âœ— halaxy/${file}.js MISSING"
              exit 1
            fi
          done
          
          echo "âœ… All Halaxy Sync Service modules verified"

      - name: Verify Build Output
        working-directory: ./api
        run: |
          echo "ðŸ” Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist/ folder not found!"
            exit 1
          fi
          
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ dist/index.js not found!"
            exit 1
          fi
          
          if [ ! -d "dist/functions" ]; then
            echo "âŒ dist/functions/ folder not found!"
            exit 1
          fi
          
          echo "ðŸ“ dist/ contents:"
          ls -la dist/
          echo "ðŸ“ dist/functions/ contents:"
          ls -la dist/functions/
          
          # Count functions
          FUNC_COUNT=$(ls -1 dist/functions/*.js 2>/dev/null | wc -l)
          echo "âœ… Found ${FUNC_COUNT} function files"
          
          if [ "$FUNC_COUNT" -eq 0 ]; then
            echo "âŒ No function .js files found in dist/functions/"
            exit 1
          fi

      - name: Package Bloom API
        working-directory: ./api
        run: |
          echo "ðŸ“¦ Creating deploy package..."
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copy compiled output
          cp -r dist/* deploy-package/
          
          # Copy required config files
          cp host.json deploy-package/
          cp package.json deploy-package/
          
          # Update package.json main entry point
          cd deploy-package
          sed -i 's|"main": "dist/index.js"|"main": "index.js"|' package.json
          
          # Install production dependencies
          npm install --production
          
          # Verify package contents
          echo "ðŸ“ deploy-package/ contents:"
          ls -la
          echo "ðŸ“ deploy-package/functions/ contents:"
          ls -la functions/
          
          echo "âœ… Package ready"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Website API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-website-api:
    name: âš¡ Build Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'

      - name: Install Website API Dependencies
        working-directory: ./apps/website/functions
        run: npm install

      - name: Build Website API
        working-directory: ./apps/website/functions
        run: |
          echo "âš¡ Building Website API..."
          npm run build
          echo "âœ… API build complete"

      - name: Package Website API
        working-directory: ./apps/website/functions
        run: |
          mkdir -p deploy-package
          cp -r dist/* deploy-package/ || true
          cp host.json deploy-package/ || true
          cp package.json deploy-package/
          cd deploy-package
          npm install --production
          echo "âœ… Package ready"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/functions/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Halaxy Sync Worker (Container Apps)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-halaxy-worker:
    name: ðŸ³ Build Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "âœ… Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Azure credentials not configured - skipping ACR push"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/halaxy-sync-worker/package-lock.json

      - name: Install Worker Dependencies
        working-directory: ./services/halaxy-sync-worker
        run: npm ci

      - name: Build Worker
        working-directory: ./services/halaxy-sync-worker
        run: |
          echo "ðŸ³ Building Halaxy Sync Worker..."
          npm run build
          echo "âœ… Build complete"

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR Login Server
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: acr
        run: |
          ACR_NAME=$(az acr list --resource-group rg-lpa-unified --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -z "$ACR_NAME" ]; then
            echo "ACR not found - will be created during infra deployment"
            echo "acr-exists=false" >> $GITHUB_OUTPUT
          else
            ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
            echo "acr-exists=true" >> $GITHUB_OUTPUT
            echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
            echo "name=$ACR_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Login to ACR
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        run: |
          az acr login --name ${{ steps.acr.outputs.name }}

      - name: Docker Meta
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.acr.outputs.login-server }}/halaxy-sync-worker
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push Docker Image
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./services/halaxy-sync-worker
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "âœ… HALAXY SYNC WORKER BUILD COMPLETE"
            echo "ðŸ³ Image: ${{ steps.meta.outputs.tags }}"
          else
            echo "âœ… HALAXY SYNC WORKER BUILD COMPLETE (TypeScript only)"
            echo "âš ï¸ Docker image not pushed - Azure credentials not configured"
            echo "ðŸ“ To enable Docker push, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 4: DEPLOY TO AZURE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-frontend:
    name: ðŸš€ Deploy Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-frontend]
    if: |
      always() &&
      needs.build-bloom-frontend.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: artifact-download

      - name: Verify and Extract Artifacts
        run: |
          cd artifact-download
          sha256sum -c bloom-frontend-dist.tar.gz.sha256
          tar -xzf bloom-frontend-dist.tar.gz
          cp -r dist ../dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.bloom-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "âœ… BLOOM FRONTEND DEPLOYED"
          echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸ”— URL: https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-website-frontend:
    name: ðŸš€ Deploy Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-website-frontend]
    if: |
      always() &&
      needs.build-website-frontend.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.website-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "âœ… WEBSITE FRONTEND DEPLOYED"
          echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸ”— URL: https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Website API (Separate Azure Functions)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-website-api:
    name: ðŸš€ Deploy Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, build-website-api]
    if: |
      always() &&
      needs.build-website-api.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: website-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.website-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Website API publish profile not configured for this environment"
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.website-api-app }}
          package: website-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.website-api-secret] }}

      - name: Deployment Summary
        run: |
          if [ "${{ steps.check-secret.outputs.secret-exists }}" == "true" ]; then
            echo "âœ… WEBSITE API DEPLOYED"
            echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "ðŸ”— URL: https://${{ needs.determine-environment.outputs.website-api-app }}.azurewebsites.net"
          else
            echo "âš ï¸ WEBSITE API DEPLOYMENT SKIPPED"
            echo "ðŸ“ Configure WEBSITE_API_PUBLISH_PROFILE secret to enable deployment"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-api:
    name: ðŸš€ Deploy Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-api]
    if: |
      always() &&
      needs.build-bloom-api.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: bloom-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.bloom-api-app }}
          package: bloom-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}

      - name: Sync Function Triggers
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "ðŸ”„ Waiting for deployment to settle..."
          sleep 15
          
          # Extract credentials from publish profile
          PUBLISH_PROFILE='${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}'
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | sed 's/userName="//')
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | sed 's/userPWD="//')
          
          echo "ðŸ”„ Triggering function sync..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/functions/synctriggers" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 60 || echo "âš ï¸ Sync trigger request completed (may have timed out)"
          
          echo "ðŸ”„ Restarting function app to ensure functions are loaded..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/restart" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 30 || echo "âš ï¸ Restart request sent"
          
          sleep 10
          echo "âœ… Function sync and restart complete"

      - name: Trigger Halaxy Sync
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "ðŸ”„ Waiting for function app to be fully ready..."
          sleep 20
          
          echo "ðŸ”„ Triggering Halaxy sync to populate availability data..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net/api/halaxy/sync" \
            -H "Content-Type: application/json" \
            --silent --show-error --max-time 120 \
            -w "\nðŸ“Š HTTP Status: %{http_code}\n" || echo "âš ï¸ Sync trigger request completed"
          
          echo "âœ… Halaxy sync triggered successfully"

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "âœ… BLOOM API DEPLOYED"
          echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸ”— URL: https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "ðŸ”„ Halaxy Sync: Triggered automatically"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Halaxy Sync Worker (Container Apps)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-halaxy-worker:
    name: ðŸ³ Deploy Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, build-halaxy-worker]
    if: |
      always() &&
      needs.build-halaxy-worker.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "âœ… Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Azure credentials not configured - skipping deployment"
            echo "ðŸ“ To enable deployment, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Container App
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Wait for the container app to exist (Bicep may still be provisioning)
          echo "â³ Waiting for container app $APP_NAME to exist..."
          for i in {1..30}; do
            if az containerapp show --name "$APP_NAME" --resource-group "$RG_NAME" --query "name" -o tsv 2>/dev/null; then
              echo "âœ… Container app exists"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "âŒ Timed out waiting for container app $APP_NAME"
              exit 1
            fi
            echo "   Attempt $i/30 - container app not found, retrying in 10s..."
            sleep 10
          done
          
          # Get ACR info
          ACR_NAME=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
          
          # Use short SHA (7 chars) to match docker/metadata-action tag format
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          
          # Update container app with new image (fail the job on error)
          az containerapp update \
            --name $APP_NAME \
            --resource-group $RG_NAME \
            --image "${ACR_SERVER}/halaxy-sync-worker:${SHORT_SHA}"

      - name: Verify Deployment
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Wait for container to be ready
          for i in {1..30}; do
            STATUS=$(az containerapp show --name $APP_NAME --resource-group $RG_NAME --query "properties.runningStatus" -o tsv 2>/dev/null || echo "NotFound")
            if [ "$STATUS" == "Running" ]; then
              echo "âœ… Container is running"
              break
            fi
            echo "Waiting for container to start... ($i/30)"
            sleep 10
          done

      - name: Verify Container Health
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        continue-on-error: true  # Don't fail deployment if health check times out
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          echo "â„¹ï¸  Note: Halaxy sync worker is a placeholder service"
          echo "â„¹ï¸  It provides health checks and infrastructure but does not sync data"
          echo "â„¹ï¸  Data is fetched directly from Halaxy public APIs at request time"
          
          # Just verify the container is healthy
          echo "ðŸ” Checking container health..."
          
          for i in {1..6}; do
            STATUS=$(az containerapp show --name $APP_NAME --resource-group $RG_NAME --query "properties.runningStatus" -o tsv 2>/dev/null || echo "NotFound")
            
            if [ "$STATUS" == "Running" ]; then
              echo "âœ… Container is running and healthy"
              exit 0
            fi
            
            if [ "$i" -eq 6 ]; then
              echo "âš ï¸ Container status: $STATUS"
              echo "ðŸ“ This is informational only - deployment can proceed"
              exit 0
            fi
            
            echo "   Status: $STATUS - checking again in 10s ($i/6)..."
            sleep 10
          done

      - name: Deployment Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "âœ… HALAXY SYNC WORKER DEPLOYED"
            echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "ðŸ³ Container App: lpa-halaxy-sync-${{ needs.determine-environment.outputs.environment }}"
          else
            echo "âš ï¸ DEPLOYMENT SKIPPED - Azure credentials not configured"
            echo "ðŸ“ Build was successful, but deployment requires:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 5: DEPLOYMENT SUMMARY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - detect-changes
      - run-migrations
      - deploy-bloom-frontend
      - deploy-bloom-api
      - deploy-website-frontend
      - deploy-website-api
      - deploy-halaxy-worker
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ðŸŒ¸ LIFE PSYCHOLOGY DEPLOYMENT SUMMARY ðŸŒ¸               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŒ Environment:     ${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸ“… Date:            $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ”– Commit:          ${{ github.sha }}"
          echo "ðŸ‘¤ Triggered by:    ${{ github.actor }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "CHANGES DETECTED"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŒ¸ Bloom Frontend:  ${{ needs.detect-changes.outputs.bloom-frontend }}"
          echo "ðŸ”Œ Bloom API:       ${{ needs.detect-changes.outputs.bloom-api }}"
          echo "ðŸ”„ Halaxy Worker:   ${{ needs.detect-changes.outputs.halaxy-worker }}"
          echo "ðŸŒ Website Frontend: ${{ needs.detect-changes.outputs.website-frontend }}"
          echo "âš¡ Website API:     ${{ needs.detect-changes.outputs.website-api }}"
          echo "ðŸ—„ï¸ Database:        ${{ needs.detect-changes.outputs.database }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "DEPLOYMENT STATUS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸ—„ï¸ Migrations:      ${{ needs.run-migrations.result }}"
          echo "ðŸŒ¸ Bloom Frontend:  ${{ needs.deploy-bloom-frontend.result }}"
          echo "ðŸ”Œ Bloom API:       ${{ needs.deploy-bloom-api.result }}"
          echo "ðŸ”„ Halaxy Worker:   ${{ needs.deploy-halaxy-worker.result }}"
          echo "ðŸŒ Website Frontend: ${{ needs.deploy-website-frontend.result }}"
          echo "âš¡ Website API:     ${{ needs.deploy-website-api.result }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "APPLICATION URLS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸŒ¸ Bloom Portal:    https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "ðŸ”Œ Bloom API:       https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "ðŸŒ Website:         https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo ""

          # Check for failures (skipped is OK)
          MIGRATIONS="${{ needs.run-migrations.result }}"
          BLOOM_FE="${{ needs.deploy-bloom-frontend.result }}"
          BLOOM_API="${{ needs.deploy-bloom-api.result }}"
          WEBSITE_FE="${{ needs.deploy-website-frontend.result }}"
          WEBSITE_API="${{ needs.deploy-website-api.result }}"
          
          if [[ "$MIGRATIONS" == "failure" ]] || [[ "$BLOOM_FE" == "failure" ]] || \
             [[ "$BLOOM_API" == "failure" ]] || [[ "$WEBSITE_FE" == "failure" ]] || \
             [[ "$WEBSITE_API" == "failure" ]]; then
            echo "âŒ DEPLOYMENT FAILED - See logs above"
            exit 1
          else
            echo "âœ… DEPLOYMENT SUCCESSFUL"
          fi
