# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIFE PSYCHOLOGY MONOREPO CI/CD WORKFLOW
# Multi-App Deployment Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# APPLICATIONS:
# 1. Bloom Portal (apps/bloom) + Bloom API (apps/bloom/api)
# 2. Website (apps/website) + Website API (apps/website/functions)
# 3. Shared Packages (@shared/*)
#
# ENVIRONMENTS:
# - Development (develop branch)
# - Staging (staging branch)
# - Production (main branch)
#
# TRIGGERS:
# - Auto-deploy on push to main/staging/develop
# - Manual deployment via workflow_dispatch
# - Smart change detection per app
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Monorepo Deploy

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
      - develop   # Development
  pull_request:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      deploy_bloom:
        description: 'Deploy Bloom Portal'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy Website'
        required: false
        type: boolean
        default: true
      deploy_apis:
        description: 'Deploy APIs'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 1: SETUP & CHANGE DETECTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect Changes (Determine What to Build/Deploy)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      bloom-frontend: ${{ steps.filter.outputs.bloom-frontend }}
      bloom-api: ${{ steps.filter.outputs.bloom-api }}
      website-frontend: ${{ steps.filter.outputs.website-frontend }}
      website-api: ${{ steps.filter.outputs.website-api }}
      shared-packages: ${{ steps.filter.outputs.shared-packages }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect File Changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bloom-frontend:
              - 'apps/bloom/src/**'
              - 'apps/bloom/public/**'
              - 'apps/bloom/index.html'
              - 'apps/bloom/vite.config.ts'
              - 'apps/bloom/package.json'
              - 'apps/bloom/staticwebapp.config.json'
            bloom-api:
              - 'apps/bloom/api/**'
            website-frontend:
              - 'apps/website/src/**'
              - 'apps/website/public/**'
              - 'apps/website/index.html'
              - 'apps/website/vite.config.ts'
              - 'apps/website/package.json'
              - 'apps/website/staticwebapp.config.json'
            website-api:
              - 'apps/website/functions/**'
            shared-packages:
              - 'packages/**'
            infrastructure:
              - '.github/workflows/**'
              - 'pnpm-workspace.yaml'
              - 'package.json'

      - name: Display Changes
        run: |
          echo "ğŸŒ¸ Bloom Frontend: ${{ steps.filter.outputs.bloom-frontend }}"
          echo "ğŸ”Œ Bloom API: ${{ steps.filter.outputs.bloom-api }}"
          echo "ğŸŒ Website Frontend: ${{ steps.filter.outputs.website-frontend }}"
          echo "âš¡ Website API: ${{ steps.filter.outputs.website-api }}"
          echo "ğŸ“¦ Shared Packages: ${{ steps.filter.outputs.shared-packages }}"
          echo "ğŸ—ï¸ Infrastructure: ${{ steps.filter.outputs.infrastructure }}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Environment Configuration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  determine-environment:
    name: ğŸŒ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should-deploy: ${{ steps.config.outputs.should_deploy }}
      # Bloom Portal
      bloom-frontend-app: ${{ steps.config.outputs.bloom_frontend_app }}
      bloom-api-app: ${{ steps.config.outputs.bloom_api_app }}
      bloom-frontend-secret: ${{ steps.config.outputs.bloom_frontend_secret }}
      bloom-api-secret: ${{ steps.config.outputs.bloom_api_secret }}
      # Website
      website-frontend-app: ${{ steps.config.outputs.website_frontend_app }}
      website-api-app: ${{ steps.config.outputs.website_api_app }}
      website-frontend-secret: ${{ steps.config.outputs.website_frontend_secret }}
      website-api-secret: ${{ steps.config.outputs.website_api_secret }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          REF="${{ github.ref }}"
          MANUAL_ENV="${{ github.event.inputs.environment }}"

          echo "ğŸ“ Branch/Ref: $REF"
          echo "ğŸ¯ Manual Override: $MANUAL_ENV"

          # Use manual input if workflow_dispatch, otherwise use branch
          if [ -n "$MANUAL_ENV" ]; then
            ENV="$MANUAL_ENV"
          else
            case "$REF" in
              refs/heads/main)
                ENV="production"
                ;;
              refs/heads/staging)
                ENV="staging"
                ;;
              refs/heads/develop)
                ENV="development"
                ;;
              refs/pull/*)
                ENV="preview"
                ;;
              *)
                ENV="preview"
                ;;
            esac
          fi

          # Set resource names based on environment
          case "$ENV" in
            production)
              # Bloom Portal - Production
              BLOOM_FRONTEND_APP="lpa-bloom-prod"
              BLOOM_API_APP="bloom-platform-functions-v2"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD"
              BLOOM_API_SECRET="BLOOM_PROD_API_PUBLISH_PROFILE"
              
              # Website - Production
              WEBSITE_FRONTEND_APP="lpa-website-prod"
              WEBSITE_API_APP="lpa-website-functions-prod"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD"
              WEBSITE_API_SECRET="WEBSITE_PROD_API_PUBLISH_PROFILE"
              
              SHOULD_DEPLOY="true"
              ;;
            staging)
              # Bloom Portal - Staging
              BLOOM_FRONTEND_APP="lpa-bloom-staging"
              BLOOM_API_APP="bloom-functions-staging-new"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING"
              BLOOM_API_SECRET="BLOOM_STAGING_API_PUBLISH_PROFILE"
              
              # Website - Staging
              WEBSITE_FRONTEND_APP="lpa-website-staging"
              WEBSITE_API_APP="lpa-website-functions-staging"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING"
              WEBSITE_API_SECRET="WEBSITE_STAGING_API_PUBLISH_PROFILE"
              
              SHOULD_DEPLOY="true"
              ;;
            development)
              # Bloom Portal - Development
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV"
              BLOOM_API_SECRET="BLOOM_DEV_API_PUBLISH_PROFILE"
              
              # Website - Development
              WEBSITE_FRONTEND_APP="lpa-website-dev"
              WEBSITE_API_APP="lpa-website-functions-dev"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV"
              WEBSITE_API_SECRET="WEBSITE_DEV_API_PUBLISH_PROFILE"
              
              SHOULD_DEPLOY="true"
              ;;
            preview)
              # Preview - use dev resources
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_FRONTEND_SECRET=""
              BLOOM_API_SECRET=""
              
              WEBSITE_FRONTEND_APP="lpa-website-dev"
              WEBSITE_API_APP="lpa-website-functions-dev"
              WEBSITE_FRONTEND_SECRET=""
              WEBSITE_API_SECRET=""
              
              SHOULD_DEPLOY="false"
              ;;
          esac

          # Output configuration
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          
          # Bloom Portal
          echo "bloom_frontend_app=$BLOOM_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_app=$BLOOM_API_APP" >> $GITHUB_OUTPUT
          echo "bloom_frontend_secret=$BLOOM_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "bloom_api_secret=$BLOOM_API_SECRET" >> $GITHUB_OUTPUT
          
          # Website
          echo "website_frontend_app=$WEBSITE_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "website_api_app=$WEBSITE_API_APP" >> $GITHUB_OUTPUT
          echo "website_frontend_secret=$WEBSITE_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "website_api_secret=$WEBSITE_API_SECRET" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ENVIRONMENT CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:         $ENV"
          echo "ğŸš€ Should Deploy:       $SHOULD_DEPLOY"
          echo ""
          echo "ğŸŒ¸ Bloom Frontend:      $BLOOM_FRONTEND_APP"
          echo "ğŸ”Œ Bloom API:           $BLOOM_API_APP"
          echo ""
          echo "ğŸŒ Website Frontend:    $WEBSITE_FRONTEND_APP"
          echo "âš¡ Website API:         $WEBSITE_API_APP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Quality Checks (Run in Parallel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  type-check:
    name: ğŸ” Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npx tsc --noEmit

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 2: BUILD APPLICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-frontend:
    name: ğŸŒ¸ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.bloom-frontend == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_bloom == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Bloom Application
        env:
          MODE: ${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'development' }}
        run: |
          set -x
          echo "ğŸŒ¸ Building Bloom Frontend..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ—ï¸  Build Mode: $MODE"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.bloom-frontend-app }}"
          npm run build:bloom -- --mode $MODE
          echo "âœ… Build complete"

      - name: Post-build diagnostics
        run: |
          set -x
          echo "=== Build environment ==="
          node -v || true
          npm -v || true
          echo "PWD=$(pwd)"
          echo "USER=$(whoami)"
          echo "Workspace contents (top 50 lines):"
          ls -la . | head -n 50
          echo "Frontend dist contents:"
          if [ -d "./dist" ]; then
            ls -la ./dist | head -n 100
            echo "Recursive listing (first 200 files):"
            find ./dist -type f -print | head -n 200
            echo "SHA256 checksums (first 200 files):"
            find ./dist -type f -print0 | head -z -n 200 | xargs -0 sha256sum 2>/dev/null || true
            echo "Disk usage:"
            du -sh ./dist || true
            echo "File count:"
            find ./dist -type f | wc -l
          else
            echo "âŒ No ./dist directory found after build!"
            exit 1
          fi

      - name: Verify Build Output
        run: |
          echo "ğŸ” Checking build output..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ dist/index.html not found after build!"
            echo "Directory contents:"
            ls -R dist/ || true
            exit 1
          fi
          echo "âœ… Build output verified: dist/index.html exists"
          ls -lh dist/index.html

      - name: Package frontend artifacts
        run: |
          set -x
          echo "ğŸ“¦ Creating packaged artifact with checksums..."
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256
          echo "Package size:"
          ls -lh bloom-frontend-dist.tar.gz
          echo "Checksum:"
          cat bloom-frontend-dist.tar.gz.sha256

      - name: Upload Bloom Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            bloom-frontend-dist.tar.gz
            bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-website-frontend:
    name: ğŸŒ Build Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.website-frontend == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_website == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Website Dependencies
        working-directory: apps/website
        run: npm install

      - name: Build Website Application
        run: |
          echo "ğŸŒ Building Website Frontend..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.website-frontend-app }}"
          npm run build:website
          echo "âœ… Build complete"

      - name: Verify Build Output
        run: |
          echo "ğŸ” Checking website build output..."
          ls -lah apps/website/dist/
          if [ ! -f "apps/website/dist/index.html" ]; then
            echo "âŒ apps/website/dist/index.html not found after build!"
            exit 1
          fi
          echo "âœ… Build output verified"

      - name: Upload Website Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/dist/
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-api:
    name: ğŸ”Œ Build Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.bloom-api == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_apis == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'

      - name: Install API Dependencies
        working-directory: ./api
        run: npm install

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "ğŸ”Œ Building Bloom API..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.bloom-api-app }}"
          npm run build
          echo "âœ… API build complete"

      - name: Package Bloom API
        working-directory: ./api
        run: |
          echo "ğŸ“¦ Packaging Bloom API..."
          mkdir -p deploy-package
          
          # Copy compiled functions
          cp -r dist/* deploy-package/ || true
          
          # Copy configuration
          cp host.json deploy-package/ || true
          cp package.json deploy-package/
          
          # Install production dependencies
          cd deploy-package
          npm install --production
          
          echo "âœ… Package ready"
          du -sh .
          ls -la

      - name: Upload Bloom API Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Website API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-website-api:
    name: âš¡ Build Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.website-api == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_apis == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'

      - name: Install Website API Dependencies
        working-directory: ./apps/website/functions
        run: npm install

      - name: Build Website API
        working-directory: ./apps/website/functions
        run: |
          echo "âš¡ Building Website API..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.website-api-app }}"
          npm run build
          echo "âœ… API build complete"

      - name: Package Website API
        working-directory: ./apps/website/functions
        run: |
          echo "ğŸ“¦ Packaging Website API..."
          mkdir -p deploy-package
          
          # Copy compiled functions
          cp -r dist/* deploy-package/ || true
          
          # Copy configuration
          cp host.json deploy-package/ || true
          cp package.json deploy-package/
          
          # Install production dependencies
          cd deploy-package
          npm install --production
          
          echo "âœ… Package ready"
          du -sh .
          ls -la

      - name: Upload Website API Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/functions/deploy-package/**
          if-no-files-found: error
          retention-days: 7

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 3: DEPLOY TO AZURE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-frontend:
    name: ğŸš€ Deploy Bloom Frontend â†’ ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-bloom-frontend]
    if: |
      always() &&
      needs.build-bloom-frontend.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Bloom Frontend Artifacts
        id: download
        uses: actions/download-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: artifact-download

      - name: Verify downloaded artifacts
        id: verify-artifacts
        run: |
          set -x
          echo "=== Artifact Download Verification ==="
          echo "Download path: artifact-download"
          echo "PWD=$(pwd)"
          echo "Listing artifact-download:"
          ls -la artifact-download/ | head -n 100
          
          # Verify checksum file exists
          if [ ! -f "artifact-download/bloom-frontend-dist.tar.gz.sha256" ]; then
            echo "âŒ Checksum file missing!"
            ls -R artifact-download/ | head -n 200
            exit 1
          fi
          
          # Verify archive exists
          if [ ! -f "artifact-download/bloom-frontend-dist.tar.gz" ]; then
            echo "âŒ Archive file missing!"
            ls -R artifact-download/ | head -n 200
            exit 1
          fi
          
          # Validate checksum
          echo "Validating checksum..."
          cd artifact-download
          sha256sum -c bloom-frontend-dist.tar.gz.sha256 || {
            echo "âŒ Checksum validation failed!"
            exit 1
          }
          echo "âœ… Checksum validated"
          
          # List archive contents
          echo "Archive contents (first 200 entries):"
          tar -tzf bloom-frontend-dist.tar.gz | head -n 200
          
          # Extract archive
          echo "Extracting archive..."
          tar -xzf bloom-frontend-dist.tar.gz
          cd ..
          
          # Verify extracted contents
          echo "Post-extract listing:"
          ls -la artifact-download/dist/ | head -n 100 || true
          echo "File checksums (first 200):"
          find artifact-download/dist -type f -print0 | head -z -n 200 | xargs -0 sha256sum 2>/dev/null || true
          
          # Critical check: index.html must exist
          if [ ! -f "artifact-download/dist/index.html" ]; then
            echo "âŒ dist/index.html missing after extraction!"
            echo "Creating debug archive for inspection..."
            tar -czf debug-workspace.tar.gz . 2>/dev/null || true
            echo "Debug archive created"
            exit 1
          fi
          
          echo "âœ… Artifacts verified successfully"
          ls -lh artifact-download/dist/index.html
          
          # Copy to expected location for deployment
          cp -r artifact-download/dist ./dist
          echo "âœ… Artifacts copied to ./dist for deployment"

      - name: Upload debug workspace on failure
        if: failure() && steps.verify-artifacts.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: debug-workspace-${{ needs.determine-environment.outputs.environment }}-${{ github.run_id }}
          path: debug-workspace.tar.gz
          if-no-files-found: ignore
          retention-days: 7

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.bloom-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BLOOM FRONTEND DEPLOYED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:  ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸŒ¸ Application:  ${{ needs.determine-environment.outputs.bloom-frontend-app }}"
          echo "ğŸ”— URL:          https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-website-frontend:
    name: ğŸš€ Deploy Website Frontend â†’ ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-website-frontend, build-website-api]
    if: |
      always() &&
      (needs.build-website-frontend.result == 'success' || needs.build-website-api.result == 'success') &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Website Frontend Artifacts (if built)
        id: download-frontend
        uses: actions/download-artifact@v4
        if: needs.build-website-frontend.result == 'success'
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: dist

      - name: Build Website Frontend (if not already built)
        if: needs.build-website-frontend.result != 'success'
        run: |
          echo "ğŸ”§ Frontend was not built in this run, building now for API deployment..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          
      - name: Setup Node.js (for on-the-fly build)
        if: needs.build-website-frontend.result != 'success'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install and Build (for on-the-fly build)
        if: needs.build-website-frontend.result != 'success'
        working-directory: apps/website
        run: |
          npm install
          npm run build:website
          # Move build output to expected location
          mv dist ../../dist
        env:
          MODE: ${{ needs.determine-environment.outputs.environment }}

      - name: Download Website API Artifacts (if built)
        id: download-api
        uses: actions/download-artifact@v4
        if: needs.build-website-api.result == 'success'
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: api-dist

      - name: Verify Artifacts
        run: |
          echo "ğŸ” Verifying Website deployment artifacts..."
          echo "ğŸ“‚ Working directory:"
          pwd
          
          echo ""
          echo "ğŸ“¦ Frontend artifacts:"
          if [ -d "dist" ]; then
            ls -lah dist/
            if [ ! -f "dist/index.html" ]; then
              echo "âŒ dist/index.html not found!"
              echo "ğŸ“‚ Full directory structure:"
              ls -R dist/
              exit 1
            fi
            echo "âœ… Frontend artifacts verified"
          else
            echo "âŒ dist directory not found!"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“¦ API artifacts:"
          if [ -d "api-dist" ]; then
            ls -lah api-dist/
            echo "âœ… API artifacts found (will be deployed as managed functions)"
          else
            echo "â„¹ï¸  No API artifacts (API deployment skipped)"
          fi

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.website-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          api_location: 'api-dist'
          skip_app_build: true
          skip_api_build: false
        env:
          NODE_VERSION: ${{ env.NODE_VERSION_API }}

      - name: Deployment Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… WEBSITE FRONTEND DEPLOYED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:  ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸŒ Application:  ${{ needs.determine-environment.outputs.website-frontend-app }}"
          echo "ğŸ”— URL:          https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-api:
    name: ğŸš€ Deploy Bloom API â†’ ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-bloom-api]
    if: |
      always() &&
      needs.build-bloom-api.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download Bloom API Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: bloom-api-dist

      - name: Verify Bloom API Artifacts
        run: |
          echo "ğŸ” Verifying Bloom API artifacts..."
          if [ ! -f "bloom-api-dist/host.json" ]; then
            echo "âš ï¸  host.json not found, but continuing..."
          fi
          echo "âœ… Bloom API artifacts ready"
          ls -lah bloom-api-dist/

      - name: Check Publish Profile Secret
        id: check-secret
        run: |
          SECRET_NAME="${{ needs.determine-environment.outputs.bloom-api-secret }}"
          echo "ğŸ” Checking for publish profile: $SECRET_NAME"
          
          if [ -z "${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Secret not configured"
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Secret configured"
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.bloom-api-app }}
          package: bloom-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BLOOM API DEPLOYED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:  ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ”Œ Function App: ${{ needs.determine-environment.outputs.bloom-api-app }}"
          echo "ğŸ”— URL:          https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Website API (DISABLED - Using Managed Functions with Static Web App)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-website-api:
    name: ğŸš€ Deploy Website API â†’ ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-website-api]
    # DISABLED: API is now deployed as managed functions with the frontend
    if: false
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download Website API Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: website-api-dist

      - name: Verify Website API Artifacts
        run: |
          echo "ğŸ” Verifying Website API artifacts..."
          if [ ! -f "website-api-dist/host.json" ]; then
            echo "âš ï¸  host.json not found, but continuing..."
          fi
          echo "âœ… Website API artifacts ready"
          ls -lah website-api-dist/

      - name: Check Publish Profile Secret
        id: check-secret
        run: |
          SECRET_NAME="${{ needs.determine-environment.outputs.website-api-secret }}"
          echo "ğŸ” Checking for publish profile: $SECRET_NAME"
          
          if [ -z "${{ secrets[needs.determine-environment.outputs.website-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Secret not configured"
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Secret configured"
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.website-api-app }}
          package: website-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.website-api-secret] }}

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… WEBSITE API DEPLOYED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:  ${{ needs.determine-environment.outputs.environment }}"
          echo "âš¡ Function App: ${{ needs.determine-environment.outputs.website-api-app }}"
          echo "ğŸ”— URL:          https://${{ needs.determine-environment.outputs.website-api-app }}.azurewebsites.net"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 4: POST-DEPLOYMENT SUMMARY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - detect-changes
      - deploy-bloom-frontend
      - deploy-bloom-api
      - deploy-website-frontend
      - deploy-website-api
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸŒ¸ LIFE PSYCHOLOGY DEPLOYMENT SUMMARY ğŸŒ¸               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Environment:     ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“… Date:            $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”– Commit:          ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by:    ${{ github.actor }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "CHANGES DETECTED"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸŒ¸ Bloom Frontend:  ${{ needs.detect-changes.outputs.bloom-frontend }}"
          echo "ğŸ”Œ Bloom API:       ${{ needs.detect-changes.outputs.bloom-api }}"
          echo "ğŸŒ Website Frontend: ${{ needs.detect-changes.outputs.website-frontend }}"
          echo "âš¡ Website API:     ${{ needs.detect-changes.outputs.website-api }}"
          echo "ğŸ“¦ Shared Packages: ${{ needs.detect-changes.outputs.shared-packages }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "DEPLOYMENT STATUS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸŒ¸ Bloom Frontend:  ${{ needs.deploy-bloom-frontend.result }}"
          echo "   â””â”€ App:          ${{ needs.determine-environment.outputs.bloom-frontend-app }}"
          echo "ğŸ”Œ Bloom API:       ${{ needs.deploy-bloom-api.result }}"
          echo "   â””â”€ App:          ${{ needs.determine-environment.outputs.bloom-api-app }}"
          echo "ğŸŒ Website (Frontend + API): ${{ needs.deploy-website-frontend.result }}"
          echo "   â””â”€ App:          ${{ needs.determine-environment.outputs.website-frontend-app }}"
          echo "   â””â”€ Note:         API deployed as managed functions"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "APPLICATION URLS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸŒ¸ Bloom Portal:    https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "ğŸ”Œ Bloom API:       https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "ğŸŒ Website:         https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo "âš¡ Website API:     https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net/api"
          echo ""

          # Check for failures
          BLOOM_FE="${{ needs.deploy-bloom-frontend.result }}"
          BLOOM_API="${{ needs.deploy-bloom-api.result }}"
          WEBSITE="${{ needs.deploy-website-frontend.result }}"
          
          if [[ "$BLOOM_FE" == "failure" ]] || [[ "$BLOOM_API" == "failure" ]] || \
             [[ "$WEBSITE" == "failure" ]]; then
            echo "âŒ DEPLOYMENT FAILED - See logs above"
            exit 1
          elif [[ "$BLOOM_FE" == "skipped" ]] && [[ "$BLOOM_API" == "skipped" ]] && \
               [[ "$WEBSITE" == "skipped" ]]; then
            echo "â„¹ï¸  NO CHANGES - Deployment skipped"
          else
            echo "âœ… DEPLOYMENT SUCCESSFUL"
          fi
