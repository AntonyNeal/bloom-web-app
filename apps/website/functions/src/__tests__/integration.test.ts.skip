// Integration test for Azure Functions HTTP endpoints
import axios from 'axios';

const FUNCTION_BASE_URL =
  process.env.AZURE_FUNCTION_URL || 'http://localhost:7071/api';

describe('Azure Functions API Integration Tests', () => {
  beforeAll(async () => {
    // Wait for function app to be ready
    const maxRetries = 10;
    let retries = 0;

    while (retries < maxRetries) {
      try {
        await axios.get(`${FUNCTION_BASE_URL}/health`, { timeout: 5000 });
        break;
      } catch (error) {
        retries++;
        if (retries === maxRetries) {
          console.warn('Function app may not be running. Some tests may fail.');
        }
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }
    }
  });

  describe('GET /api/get-sas-token', () => {
    it('should return 400 for missing parameters', async () => {
      const response = await axios.get(`${FUNCTION_BASE_URL}/get-sas-token`, {
        validateStatus: () => true, // Don't throw on 4xx/5xx
      });

      expect(response.status).toBe(400);
      expect(response.data).toHaveProperty('error');
    });

    it('should return SAS token for valid parameters', async () => {
      const response = await axios.get(`${FUNCTION_BASE_URL}/get-sas-token`, {
        params: {
          containerName: 'test',
          fileName: 'test.pdf',
        },
        validateStatus: () => true,
      });

      // This might be 500 if Azure Storage is not configured, which is expected in test
      expect([200, 500]).toContain(response.status);

      if (response.status === 200) {
        expect(response.data).toHaveProperty('sasUrl');
      }
    });
  });

  describe('POST /api/submit', () => {
    it('should return 400 for missing application data', async () => {
      const response = await axios.post(
        `${FUNCTION_BASE_URL}/submit`,
        {},
        { validateStatus: () => true }
      );

      expect(response.status).toBe(400);
      expect(response.data).toHaveProperty('error');
    });

    it('should handle valid application submission', async () => {
      const testApplication = {
        personalInfo: {
          firstName: 'Test',
          lastName: 'User',
          email: 'test@example.com',
          phone: '1234567890',
        },
        preferences: {
          serviceType: 'individual',
          location: 'sydney',
        },
      };

      const response = await axios.post(
        `${FUNCTION_BASE_URL}/submit`,
        testApplication,
        { validateStatus: () => true }
      );

      // This might be 500 if database is not configured, which is expected in test
      expect([200, 201, 500]).toContain(response.status);

      if (response.status === 200 || response.status === 201) {
        expect(response.data).toHaveProperty('submissionId');
      }
    });
  });
});
