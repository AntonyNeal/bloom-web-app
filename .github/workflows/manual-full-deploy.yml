name: Manual Full Deploy
# Force Deploy All Apps - No Change Detection
#
# This workflow deploys ALL applications regardless of changes.
# Use this for:
# - Testing deployment pipeline
# - Force deploying after infrastructure changes
# - Recovering from failed deployments
# - Deploying all apps to a specific environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[â€¦]
  # Determine Environment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[â€¦]

  determine-environment:
    name: ğŸŒ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      bloom-frontend-app: ${{ steps.set-env.outputs.bloom-frontend-app }}
      bloom-frontend-secret: ${{ steps.set-env.outputs.bloom-frontend-secret }}
      bloom-api-app: ${{ steps.set-env.outputs.bloom-api-app }}
      bloom-api-secret: ${{ steps.set-env.outputs.bloom-api-secret }}
      website-frontend-app: ${{ steps.set-env.outputs.website-frontend-app }}
      website-frontend-secret: ${{ steps.set-env.outputs.website-frontend-secret }}
      website-api-app: ${{ steps.set-env.outputs.website-api-app }}
      website-api-secret: ${{ steps.set-env.outputs.website-api-secret }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Set Environment Variables
        id: set-env
        run: |
          ENV="${{ github.event.inputs.environment }}"
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          
          if [ "$ENV" = "production" ]; then
            echo "bloom-frontend-app=lpa-bloom-prod" >> $GITHUB_OUTPUT
            echo "bloom-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD" >> $GITHUB_OUTPUT
            echo "bloom-api-app=fnt42kldozqahcu" >> $GITHUB_OUTPUT
            echo "bloom-api-secret=BLOOM_PROD_API_PUBLISH_PROFILE" >> $GITHUB_OUTPUT
            echo "website-frontend-app=lpa-frontend-prod" >> $GITHUB_OUTPUT
            echo "website-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD" >> $GITHUB_OUTPUT
            echo "website-api-app=" >> $GITHUB_OUTPUT  # Managed functions
            echo "website-api-secret=" >> $GITHUB_OUTPUT  # Not used
          elif [ "$ENV" = "staging" ]; then
            echo "bloom-frontend-app=lpa-bloom-staging" >> $GITHUB_OUTPUT
            echo "bloom-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING" >> $GITHUB_OUTPUT
            echo "bloom-api-app=bloom-functions-staging-new" >> $GITHUB_OUTPUT
            echo "bloom-api-secret=BLOOM_STAGING_API_PUBLISH_PROFILE" >> $GITHUB_OUTPUT
            echo "website-frontend-app=lpa-frontend-staging" >> $GITHUB_OUTPUT
            echo "website-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING" >> $GITHUB_OUTPUT
            echo "website-api-app=" >> $GITHUB_OUTPUT  # Managed functions
            echo "website-api-secret=" >> $GITHUB_OUTPUT  # Not used
          else
            echo "bloom-frontend-app=lpa-bloom-dev" >> $GITHUB_OUTPUT
            echo "bloom-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV" >> $GITHUB_OUTPUT
            echo "bloom-api-app=bloom-functions-dev" >> $GITHUB_OUTPUT
            echo "bloom-api-secret=BLOOM_DEV_API_PUBLISH_PROFILE" >> $GITHUB_OUTPUT
            echo "website-frontend-app=lpa-frontend-dev" >> $GITHUB_OUTPUT
            echo "website-frontend-secret=AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV" >> $GITHUB_OUTPUT
            echo "website-api-app=" >> $GITHUB_OUTPUT  # Managed functions
            echo "website-api-secret=" >> $GITHUB_OUTPUT  # Not used
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[â€¦]
  # Lint & Type Check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[â€¦]

  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run Lint
        run: npm run lint

  type-check:
    name: ğŸ” Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run Type Check
        run: npx tsc --noEmit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]
  # Build Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]

  build-bloom-frontend:
    name: ğŸŒ¸ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Bloom Application
        env:
          MODE: ${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'development' }}
        run: |
          set -x
          echo "ğŸŒ¸ Building Bloom Frontend..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ—ï¸  Build Mode: $MODE"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.bloom-frontend-app }}"
          npm run build:bloom -- --mode $MODE
          echo "âœ… Build complete"

      - name: Post-build diagnostics
        run: |
          set -x
          echo "=== Build environment ==="
          node -v || true
          npm -v || true
          echo "PWD=$(pwd)"
          echo "USER=$(whoami)"
          echo "Workspace contents (top 50 lines):"
          ls -la . | head -n 50
          echo "Frontend dist contents:"
          if [ -d "./dist" ]; then
            ls -la ./dist | head -n 100
            echo "Recursive listing (first 200 files):"
            find ./dist -type f -print | head -n 200
            echo "SHA256 checksums (first 200 files):"
            find ./dist -type f -print0 | head -z -n 200 | xargs -0 sha256sum 2>/dev/null || true
            echo "Disk usage:"
            du -sh ./dist || true
            echo "File count:"
            find ./dist -type f | wc -l
          else
            echo "âŒ No ./dist directory found after build!"
            exit 1
          fi

      - name: Verify Build Output
        run: |
          echo "ğŸ” Checking build output..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ dist/index.html not found after build!"
            echo "Directory contents:"
            ls -R dist/ || true
            exit 1
          fi
          echo "âœ… Build output verified: dist/index.html exists"
          ls -lh dist/index.html

      - name: Package frontend artifacts
        run: |
          set -x
          echo "ğŸ“¦ Creating packaged artifact with checksums..."
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256
          echo "Package size:"
          ls -lh bloom-frontend-dist.tar.gz
          echo "Checksum:"
          cat bloom-frontend-dist.tar.gz.sha256

      - name: Upload Bloom Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            bloom-frontend-dist.tar.gz
            bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]
  # Build Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]

  build-website-frontend:
    name: ğŸŒ Build Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm ci

      - name: Build Website Application
        run: |
          echo "ğŸŒ Building Website Frontend..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“¦ Target: ${{ needs.determine-environment.outputs.website-frontend-app }}"
          npm run build:website
          echo "âœ… Build complete"

      - name: Verify Build Output
        run: |
          echo "ğŸ” Checking website build output..."
          ls -lah apps/website/dist/
          if [ ! -f "apps/website/dist/index.html" ]; then
            echo "âŒ apps/website/dist/index.html not found after build!"
            exit 1
          fi
          echo "âœ… Build output verified"

      - name: Upload Website Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/dist/
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]
  # Build Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]

  build-bloom-api:
    name: ğŸ”Œ Build Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: ./api
        run: npm ci

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "ğŸ”Œ Building Bloom API..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          npm run build
          echo "âœ… API Build complete"

      - name: Create Deployment Package
        working-directory: ./api
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          mkdir -p deploy-package
          cp -r dist/* deploy-package/
          cp package*.json deploy-package/
          cp host.json deploy-package/ 2>/dev/null || true
          ls -la deploy-package/

      - name: Upload Bloom API Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  build-website-api:
    name: âš¡ Build Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: "Debug: print workspace and locate lockfiles"
        run: |
          echo "WORKING DIR: $(pwd)"
          echo "TOP LEVEL:"
          ls -la || true
          echo "apps/website:"
          ls -la apps/website || true
          echo "apps/website/functions:"
          ls -la apps/website/functions || true
          echo "Find package-lock.json files (depth 6):"
          find . -maxdepth 6 -type f -name 'package-lock.json' -print || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: apps/website/functions/package-lock.json

      - name: Install Dependencies
        working-directory: ./apps/website/functions
        run: npm ci

      - name: Build Website API
        working-directory: ./apps/website/functions
        run: |
          echo "âš¡ Building Website API..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          npm run build
          echo "âœ… API Build complete"

      - name: Create Deployment Package
        working-directory: ./apps/website/functions
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          mkdir -p deploy-package
          cp -r dist/* deploy-package/
          cp package*.json deploy-package/
          cp host.json deploy-package/ 2>/dev/null || true
          ls -la deploy-package/

      - name: Upload Website API Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/functions/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½[...]
  # STAGE 3: DEPLOY APPLICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½[...]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]
  # Deploy Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½[...]