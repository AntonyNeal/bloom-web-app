# LIFE PSYCHOLOGY UNIFIED CI/CD WORKFLOW
# Combined Application Deployment + Database Migrations
#
# APPLICATIONS:
# 1. Bloom Portal (apps/bloom) + Bloom API (api/)
# 2. Website (apps/website) + Website API (apps/website/functions)
# 3. Halaxy DB Realtime Sync Service (api/src/services/halaxy/)
# 4. Database Migrations (db/migrations)
#
# ENVIRONMENTS:
# - Development (develop branch)
# - Staging (staging branch)
# - Production (main branch)
#
# TRIGGERS:
# - Auto-deploy on push to main/staging/develop
# - Smart change detection per app/db

name: CI/CD Pipeline

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
      - develop   # Development
  pull_request:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      deploy_bloom:
        description: 'Deploy Bloom Portal'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy Website'
        required: false
        type: boolean
        default: true
      deploy_apis:
        description: 'Deploy APIs'
        required: false
        type: boolean
        default: true
      run_migrations:
        description: 'Run Database Migrations'
        required: false
        type: boolean
        default: true
      deploy_halaxy_sync:
        description: 'Deploy Halaxy Sync Service'
        required: false
        type: boolean
        default: true
      dry_run_migrations:
        description: 'Dry run migrations (preview only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 1: SETUP & CHANGE DETECTION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Detect Changes (Determine What to Build/Deploy)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  detect-changes:
    name: üîé Detect Changes
    runs-on: ubuntu-latest
    outputs:
      bloom-frontend: ${{ steps.combined.outputs.bloom-frontend }}
      bloom-api: ${{ steps.combined.outputs.bloom-api }}
      website-frontend: ${{ steps.combined.outputs.website-frontend }}
      website-api: ${{ steps.combined.outputs.website-api }}
      shared-packages: ${{ steps.combined.outputs.shared-packages }}
      infrastructure: ${{ steps.combined.outputs.infrastructure }}
      database: ${{ steps.combined.outputs.database }}
      halaxy-sync: ${{ steps.combined.outputs.halaxy-sync }}
      halaxy-worker: ${{ steps.combined.outputs.halaxy-worker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for comparing commits

      # Strategy 1: paths-filter for single-commit detection
      - name: Detect File Changes (Single Commit)
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bloom-frontend:
              - 'apps/bloom/src/**'
              - 'apps/bloom/public/**'
              - 'apps/bloom/index.html'
              - 'apps/bloom/vite.config.ts'
              - 'apps/bloom/package.json'
              - 'apps/bloom/staticwebapp.config.json'
              - 'src/**'
            bloom-api:
              - 'api/**'
            website-frontend:
              - 'apps/website/src/**'
              - 'apps/website/public/**'
              - 'apps/website/index.html'
              - 'apps/website/vite.config.ts'
              - 'apps/website/package.json'
              - 'apps/website/staticwebapp.config.json'
            website-api:
              - 'apps/website/functions/**'
            shared-packages:
              - 'packages/**'
            infrastructure:
              - '.github/workflows/**'
              - 'pnpm-workspace.yaml'
              - 'package.json'
              - 'infra/**'
            database:
              - 'db/migrations/**'
              - 'api/src/db-version-control/**'
              - 'scripts/db-version-control/**'
            halaxy-sync:
              - 'api/src/services/halaxy/**'
              - 'api/src/functions/halaxy-*.ts'
            halaxy-worker:
              - 'services/halaxy-sync-worker/**'

      # Strategy 2: Check all commits in the push event (for fast-forwards with multiple commits)
      - name: Detect Changes Across All Pushed Commits
        id: push-range
        run: |
          # For push events, check all files changed across the entire push range
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"
          
          echo "üìç Push range: $BEFORE..$AFTER"
          
          # Handle initial push or force push where before is all zeros
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            echo "üÜï Initial push or new branch - will trigger all builds"
            echo "bloom-frontend=true" >> $GITHUB_OUTPUT
            echo "bloom-api=true" >> $GITHUB_OUTPUT
            echo "website-frontend=true" >> $GITHUB_OUTPUT
            echo "website-api=true" >> $GITHUB_OUTPUT
            echo "shared-packages=true" >> $GITHUB_OUTPUT
            echo "infrastructure=true" >> $GITHUB_OUTPUT
            echo "database=true" >> $GITHUB_OUTPUT
            echo "halaxy-sync=true" >> $GITHUB_OUTPUT
            echo "halaxy-worker=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get all changed files across the push range
          CHANGED_FILES=$(git diff --name-only "$BEFORE" "$AFTER" 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è Could not determine changed files, using paths-filter results only"
            echo "bloom-frontend=false" >> $GITHUB_OUTPUT
            echo "bloom-api=false" >> $GITHUB_OUTPUT
            echo "website-frontend=false" >> $GITHUB_OUTPUT
            echo "website-api=false" >> $GITHUB_OUTPUT
            echo "shared-packages=false" >> $GITHUB_OUTPUT
            echo "infrastructure=false" >> $GITHUB_OUTPUT
            echo "database=false" >> $GITHUB_OUTPUT
            echo "halaxy-sync=false" >> $GITHUB_OUTPUT
            echo "halaxy-worker=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üìù Changed files in push range:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Check each category
          check_pattern() {
            local name=$1
            shift
            for pattern in "$@"; do
              if echo "$CHANGED_FILES" | grep -qE "$pattern"; then
                echo "$name=true" >> $GITHUB_OUTPUT
                echo "‚úÖ $name: detected changes"
                return
              fi
            done
            echo "$name=false" >> $GITHUB_OUTPUT
          }
          
          check_pattern "bloom-frontend" "^apps/bloom/src/" "^apps/bloom/public/" "^apps/bloom/index.html" "^apps/bloom/vite.config.ts" "^apps/bloom/package.json" "^apps/bloom/staticwebapp.config.json" "^src/"
          check_pattern "bloom-api" "^api/"
          check_pattern "website-frontend" "^apps/website/src/" "^apps/website/public/" "^apps/website/index.html" "^apps/website/vite.config.ts" "^apps/website/package.json" "^apps/website/staticwebapp.config.json"
          check_pattern "website-api" "^apps/website/functions/"
          check_pattern "shared-packages" "^packages/"
          check_pattern "infrastructure" "^\.github/workflows/" "^pnpm-workspace.yaml" "^package.json$" "^infra/"
          check_pattern "database" "^db/migrations/" "^api/src/db-version-control/" "^scripts/db-version-control/"
          check_pattern "halaxy-sync" "^api/src/services/halaxy/" "^api/src/functions/halaxy-"
          check_pattern "halaxy-worker" "^services/halaxy-sync-worker/"

      # Combine both detection strategies (OR logic)
      - name: Combine Detection Results
        id: combined
        run: |
          combine() {
            local name=$1
            local filter_val=$2
            local range_val=$3
            if [[ "$filter_val" == "true" || "$range_val" == "true" ]]; then
              echo "$name=true" >> $GITHUB_OUTPUT
            else
              echo "$name=false" >> $GITHUB_OUTPUT
            fi
          }
          
          combine "bloom-frontend" "${{ steps.filter.outputs.bloom-frontend }}" "${{ steps.push-range.outputs.bloom-frontend }}"
          combine "bloom-api" "${{ steps.filter.outputs.bloom-api }}" "${{ steps.push-range.outputs.bloom-api }}"
          combine "website-frontend" "${{ steps.filter.outputs.website-frontend }}" "${{ steps.push-range.outputs.website-frontend }}"
          combine "website-api" "${{ steps.filter.outputs.website-api }}" "${{ steps.push-range.outputs.website-api }}"
          combine "shared-packages" "${{ steps.filter.outputs.shared-packages }}" "${{ steps.push-range.outputs.shared-packages }}"
          combine "infrastructure" "${{ steps.filter.outputs.infrastructure }}" "${{ steps.push-range.outputs.infrastructure }}"
          combine "database" "${{ steps.filter.outputs.database }}" "${{ steps.push-range.outputs.database }}"
          combine "halaxy-sync" "${{ steps.filter.outputs.halaxy-sync }}" "${{ steps.push-range.outputs.halaxy-sync }}"
          combine "halaxy-worker" "${{ steps.filter.outputs.halaxy-worker }}" "${{ steps.push-range.outputs.halaxy-worker }}"

      - name: Display Changes
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä CHANGE DETECTION RESULTS (Combined)"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üå∏ Bloom Frontend:    ${{ steps.combined.outputs.bloom-frontend }}"
          echo "üîå Bloom API:         ${{ steps.combined.outputs.bloom-api }}"
          echo "üåê Website Frontend:  ${{ steps.combined.outputs.website-frontend }}"
          echo "‚ö° Website API:       ${{ steps.combined.outputs.website-api }}"
          echo "üì¶ Shared Packages:   ${{ steps.combined.outputs.shared-packages }}"
          echo "üèóÔ∏è Infrastructure:    ${{ steps.combined.outputs.infrastructure }}"
          echo "üóÑÔ∏è Database:          ${{ steps.combined.outputs.database }}"
          echo "üîÑ Halaxy Sync:       ${{ steps.combined.outputs.halaxy-sync }}"
          echo "üë∑ Halaxy Worker:     ${{ steps.combined.outputs.halaxy-worker }}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìã Detection Sources:"
          echo "   paths-filter: Single commit analysis"
          echo "   push-range:   All commits in push (${{ github.event.before }}...${{ github.event.after }})"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Environment Configuration
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  determine-environment:
    name: üåç Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should-deploy: ${{ steps.config.outputs.should_deploy }}
      is-staging-validation: ${{ steps.config.outputs.is_staging_validation }}
      db-environment: ${{ steps.config.outputs.db_environment }}
      # Bloom Portal
      bloom-frontend-app: ${{ steps.config.outputs.bloom_frontend_app }}
      bloom-api-app: ${{ steps.config.outputs.bloom_api_app }}
      bloom-frontend-secret: ${{ steps.config.outputs.bloom_frontend_secret }}
      bloom-api-secret: ${{ steps.config.outputs.bloom_api_secret }}
      bloom-api-url: ${{ steps.config.outputs.bloom_api_url }}
      # Website
      website-frontend-app: ${{ steps.config.outputs.website_frontend_app }}
      website-api-app: ${{ steps.config.outputs.website_api_app }}
      website-frontend-secret: ${{ steps.config.outputs.website_frontend_secret }}
      website-api-secret: ${{ steps.config.outputs.website_api_secret }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          REF="${{ github.ref }}"
          MANUAL_ENV="${{ github.event.inputs.environment }}"

          echo "üìç Branch/Ref: $REF"
          echo "üéØ Manual Override: $MANUAL_ENV"

          # Use manual input if workflow_dispatch, otherwise use branch
          if [ -n "$MANUAL_ENV" ]; then
            ENV="$MANUAL_ENV"
          else
            case "$REF" in
              refs/heads/main)
                ENV="production"
                ;;
              refs/heads/staging)
                ENV="staging"
                ;;
              refs/heads/develop)
                ENV="development"
                ;;
              refs/pull/*)
                ENV="preview"
                ;;
              *)
                ENV="preview"
                ;;
            esac
          fi

          # Database environment mapping (staging uses dev DBs)
          IS_STAGING_VALIDATION="false"
          case "$ENV" in
            production)
              DB_ENV="prod"
              ;;
            staging)
              DB_ENV="dev"
              IS_STAGING_VALIDATION="true"
              ;;
            *)
              DB_ENV="dev"
              ;;
          esac

          # Set resource names based on environment
          case "$ENV" in
            production)
              BLOOM_FRONTEND_APP="lpa-bloom-prod"
              BLOOM_API_APP="bloom-platform-functions-v2"
              BLOOM_API_URL="https://bloom-platform-functions-v2.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD"
              BLOOM_API_SECRET="BLOOM_PROD_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-prod"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            staging)
              BLOOM_FRONTEND_APP="lpa-bloom-staging"
              BLOOM_API_APP="bloom-functions-staging-new"
              BLOOM_API_URL="https://bloom-functions-staging-new.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING"
              BLOOM_API_SECRET="BLOOM_STAGING_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-staging"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            development)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV"
              BLOOM_API_SECRET="BLOOM_DEV_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV"
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="true"
              ;;
            preview)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET=""
              BLOOM_API_SECRET=""
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_API_APP=""
              WEBSITE_FRONTEND_SECRET=""
              WEBSITE_API_SECRET=""
              SHOULD_DEPLOY="false"
              ;;
          esac

          # Output configuration
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_staging_validation=$IS_STAGING_VALIDATION" >> $GITHUB_OUTPUT
          echo "db_environment=$DB_ENV" >> $GITHUB_OUTPUT
          
          # Bloom Portal
          echo "bloom_frontend_app=$BLOOM_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_app=$BLOOM_API_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_url=$BLOOM_API_URL" >> $GITHUB_OUTPUT
          echo "bloom_frontend_secret=$BLOOM_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "bloom_api_secret=$BLOOM_API_SECRET" >> $GITHUB_OUTPUT
          
          # Website
          echo "website_frontend_app=$WEBSITE_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "website_api_app=$WEBSITE_API_APP" >> $GITHUB_OUTPUT
          echo "website_frontend_secret=$WEBSITE_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "website_api_secret=$WEBSITE_API_SECRET" >> $GITHUB_OUTPUT

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ ENVIRONMENT CONFIGURATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üåç Environment:         $ENV"
          echo "üóÑÔ∏è DB Environment:      $DB_ENV"
          echo "üöÄ Should Deploy:       $SHOULD_DEPLOY"
          echo "üîÑ Staging Validation:  $IS_STAGING_VALIDATION"
          echo ""
          echo "üå∏ Bloom Frontend:      $BLOOM_FRONTEND_APP"
          echo "üîå Bloom API:           $BLOOM_API_APP"
          echo "üåê Website Frontend:    $WEBSITE_FRONTEND_APP"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Quality Checks (Run in Parallel)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  lint:
    name: üîç Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint

  type-check:
    name: üîç Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Type Check
        run: npx tsc --noEmit

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 2: DATABASE MIGRATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Validate Migrations
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  validate-migrations:
    name: ‚úÖ Validate Migrations
    runs-on: ubuntu-latest
    needs: [detect-changes, determine-environment]
    if: |
      needs.detect-changes.outputs.database == 'true' ||
      github.event.inputs.run_migrations == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Validate Migration Scripts
        run: |
          echo "üîç Validating migration scripts..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              echo "   Checking: $file"
              if grep -qi "DROP DATABASE" "$file"; then
                echo "‚ùå Error: DROP DATABASE found in $file"
                exit 1
              fi
              if grep -qi "TRUNCATE.*applications" "$file" && [ "${{ needs.determine-environment.outputs.db-environment }}" == "prod" ]; then
                echo "‚ö†Ô∏è Warning: TRUNCATE on applications table in production"
              fi
            fi
          done
          
          echo "‚úÖ All migration scripts validated"

      - name: Check Migration Naming Convention
        run: |
          echo "üîç Checking migration naming conventions..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if ! [[ "$filename" =~ ^V[0-9]+[a-z]?__[a-z0-9_]+\.sql$ ]]; then
                echo "‚ö†Ô∏è Warning: $filename doesn't follow naming convention V{version}__{description}.sql"
              fi
            fi
          done
          
          echo "‚úÖ Naming convention check complete"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Run Migrations
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  run-migrations:
    name: üóÑÔ∏è Run Migrations (${{ needs.determine-environment.outputs.db-environment }})
    runs-on: ubuntu-latest
    needs: [detect-changes, determine-environment, validate-migrations, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.database == 'true' || github.event.inputs.run_migrations == 'true') &&
      needs.validate-migrations.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.db-environment == 'prod' && 'production' || needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Connection Strings from Key Vault
        id: secrets
        run: |
          ENV_SUFFIX="${{ needs.determine-environment.outputs.db-environment == 'prod' && 'PROD' || 'DEV' }}"
          
          # Use the actual Key Vault name (includes random suffix from Bicep deployment)
          KV_NAME="lpa-kv-dev-i3u6u6psuu75o"
          
          SQL_CONN=$(az keyvault secret show \
            --name "SQL-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SQL_CONN" ]; then
            echo "SQL_CONNECTION_STRING=$SQL_CONN" >> $GITHUB_ENV
          fi
          
          COSMOS_CONN=$(az keyvault secret show \
            --name "COSMOS-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$COSMOS_CONN" ]; then
            echo "DBVC_COSMOS_CONNECTION_STRING=$COSMOS_CONN" >> $GITHUB_ENV
          fi

      - name: Run Migrations
        id: migrate
        working-directory: api
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
          DRY_RUN: ${{ github.event.inputs.dry_run_migrations || github.event_name == 'pull_request' }}
        run: |
          echo "üöÄ Running migrations for ${{ needs.determine-environment.outputs.db-environment }}..."
          
          # Use simple migration runner instead of complex DBVC system
          node run-simple-migrations.js
        continue-on-error: ${{ github.event.inputs.dry_run_migrations == 'true' || github.event_name == 'pull_request' }}

      - name: Extended Validation (Staging)
        if: |
          success() && 
          needs.determine-environment.outputs.is-staging-validation == 'true' && 
          github.event.inputs.dry_run_migrations != 'true' &&
          github.event_name != 'pull_request'
        working-directory: api
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
        run: |
          echo "üî¨ Running extended validation tests (staging branch - second pass)..."
          echo "üìã This validates migrations are safe to promote to production"
          
          # Simple validation - check schema_versions table
          cat > extended-validation.js << 'EOF'
          const sql = require('mssql');
          
          async function main() {
            let pool;
            try {
              pool = await sql.connect(process.env.SQL_CONNECTION_STRING);
              
              console.log('\nüî¨ EXTENDED VALIDATION SUITE');
              console.log('‚îÅ'.repeat(50));
              
              // Check schema_versions table
              const result = await pool.request().query(`
                SELECT version, description, applied_at, applied_by 
                FROM schema_versions 
                ORDER BY applied_at DESC
              `);
              
              console.log(`\nüìã Applied migrations: ${result.recordset.length}`);
              for (const row of result.recordset.slice(0, 5)) {
                console.log(`   ‚úÖ ${row.version}: ${row.description}`);
              }
              
              // Simple schema check
              const tablesResult = await pool.request().query(`
                SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES 
                WHERE TABLE_TYPE = 'BASE TABLE'
              `);
              console.log(`\nüìä Tables in database: ${tablesResult.recordset.length}`);
              
              console.log('\n' + '‚îÅ'.repeat(50));
              console.log('‚úÖ EXTENDED VALIDATION PASSED');
              
              await pool.close();
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Extended validation error:', error.message);
              if (pool) await pool.close();
              process.exit(1);
            }
          }
          
          main();
          EOF
          
          node extended-validation.js

      - name: Migration Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.migrate.outcome }}' === 'success';
            const environment = '${{ needs.determine-environment.outputs.db-environment }}';
            const dryRun = '${{ github.event.inputs.dry_run_migrations }}' === 'true' || '${{ github.event_name }}' === 'pull_request';
            
            const summary = `## üóÉÔ∏è Database Migration Summary
            
            | Property | Value |
            |----------|-------|
            | Environment | \`${environment}\` |
            | Dry Run | ${dryRun ? '‚úÖ Yes' : '‚ùå No'} |
            | Status | ${success ? '‚úÖ Success' : '‚ùå Failed'} |
            | Commit | \`${context.sha.substring(0, 7)}\` |
            `;
            
            await core.summary.addRaw(summary).write();

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Rollback on Failure (Production only)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  rollback-migrations:
    name: üîÑ Rollback Migrations (if needed)
    runs-on: ubuntu-latest
    needs: [determine-environment, run-migrations]
    if: |
      failure() && 
      needs.determine-environment.outputs.db-environment == 'prod' && 
      github.event.inputs.dry_run_migrations != 'true' &&
      github.event_name != 'pull_request'
    environment: production
    steps:
      - name: Rollback Alert
        run: |
          echo "‚ö†Ô∏è Production migration failed!"
          echo "Manual rollback may be required."

      - name: Create Issue for Failed Migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Migration Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Migration Failure
              
              A database migration failed in production.
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit:** ${context.sha}
              
              /cc @${context.actor}
              `,
              labels: ['bug', 'production', 'database', 'urgent']
            });

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 3: BUILD APPLICATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Bloom Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-bloom-frontend:
    name: üå∏ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.bloom-frontend == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_bloom == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Bloom Application
        env:
          MODE: ${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'development' }}
          VITE_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
        run: |
          echo "üå∏ Building Bloom Frontend..."
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          npm run build:bloom -- --mode $MODE
          echo "‚úÖ Build complete"

      - name: Verify Build Output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå dist/index.html not found!"
            exit 1
          fi
          echo "‚úÖ Build verified"

      - name: Package Artifacts
        run: |
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            bloom-frontend-dist.tar.gz
            bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Website Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-website-frontend:
    name: üåê Build Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.website-frontend == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_website == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Website Dependencies
        working-directory: apps/website
        run: npm install

      - name: Build Website Application
        run: |
          echo "üåê Building Website Frontend..."
          npm run build:website
          echo "‚úÖ Build complete"
        env:
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_AVAILABILITY_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/halaxy/availability
          VITE_HALAXY_BOOKING_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/create-halaxy-booking

      - name: Verify Build Output
        run: |
          if [ ! -f "apps/website/dist/index.html" ]; then
            echo "‚ùå Build failed!"
            exit 1
          fi
          echo "‚úÖ Build verified"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/dist/
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Bloom API
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-bloom-api:
    name: üîå Build Bloom API (incl. Halaxy Sync)
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.bloom-api == 'true' ||
       needs.detect-changes.outputs.halaxy-sync == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_apis == 'true' ||
       github.event.inputs.deploy_halaxy_sync == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install API Dependencies
        working-directory: ./api
        run: npm ci

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "üîå Building Bloom API..."
          npm run build
          echo "‚úÖ API build complete"

      - name: Verify Halaxy Sync Service
        working-directory: ./api
        run: |
          echo "üîÑ Verifying Halaxy Sync Service compilation..."
          if [ -f "dist/services/halaxy/sync-service.js" ]; then
            echo "‚úÖ Halaxy Sync Service compiled successfully"
          else
            echo "‚ùå Halaxy Sync Service not found in build output!"
            exit 1
          fi
          
          # Verify all Halaxy service files
          for file in client index transformers token-manager types; do
            if [ -f "dist/services/halaxy/${file}.js" ]; then
              echo "  ‚úì halaxy/${file}.js"
            else
              echo "  ‚úó halaxy/${file}.js MISSING"
              exit 1
            fi
          done
          
          echo "‚úÖ All Halaxy Sync Service modules verified"

      - name: Verify Build Output
        working-directory: ./api
        run: |
          echo "üîç Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "‚ùå dist/ folder not found!"
            exit 1
          fi
          
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå dist/index.js not found!"
            exit 1
          fi
          
          if [ ! -d "dist/functions" ]; then
            echo "‚ùå dist/functions/ folder not found!"
            exit 1
          fi
          
          echo "üìÅ dist/ contents:"
          ls -la dist/
          echo "üìÅ dist/functions/ contents:"
          ls -la dist/functions/
          
          # Count functions
          FUNC_COUNT=$(ls -1 dist/functions/*.js 2>/dev/null | wc -l)
          echo "‚úÖ Found ${FUNC_COUNT} function files"
          
          if [ "$FUNC_COUNT" -eq 0 ]; then
            echo "‚ùå No function .js files found in dist/functions/"
            exit 1
          fi

      - name: Package Bloom API
        working-directory: ./api
        run: |
          echo "üì¶ Creating deploy package..."
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copy compiled output
          cp -r dist/* deploy-package/
          
          # Copy required config files
          cp host.json deploy-package/
          cp package.json deploy-package/
          
          # Update package.json main entry point
          cd deploy-package
          sed -i 's|"main": "dist/index.js"|"main": "index.js"|' package.json
          
          # Install production dependencies
          npm install --production
          
          # Verify package contents
          echo "üìÅ deploy-package/ contents:"
          ls -la
          echo "üìÅ deploy-package/functions/ contents:"
          ls -la functions/
          
          echo "‚úÖ Package ready"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Website API
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-website-api:
    name: ‚ö° Build Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.website-api == 'true' ||
       needs.detect-changes.outputs.shared-packages == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_apis == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'

      - name: Install Website API Dependencies
        working-directory: ./apps/website/functions
        run: npm install

      - name: Build Website API
        working-directory: ./apps/website/functions
        run: |
          echo "‚ö° Building Website API..."
          npm run build
          echo "‚úÖ API build complete"

      - name: Package Website API
        working-directory: ./apps/website/functions
        run: |
          mkdir -p deploy-package
          cp -r dist/* deploy-package/ || true
          cp host.json deploy-package/ || true
          cp package.json deploy-package/
          cd deploy-package
          npm install --production
          echo "‚úÖ Package ready"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/functions/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Halaxy Sync Worker (Container Apps)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-halaxy-worker:
    name: üê≥ Build Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      (needs.detect-changes.outputs.halaxy-worker == 'true' ||
       needs.detect-changes.outputs.infrastructure == 'true' ||
       github.event.inputs.deploy_halaxy_sync == 'true') &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Azure credentials not configured - skipping ACR push"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/halaxy-sync-worker/package-lock.json

      - name: Install Worker Dependencies
        working-directory: ./services/halaxy-sync-worker
        run: npm ci

      - name: Build Worker
        working-directory: ./services/halaxy-sync-worker
        run: |
          echo "üê≥ Building Halaxy Sync Worker..."
          npm run build
          echo "‚úÖ Build complete"

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR Login Server
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: acr
        run: |
          ACR_NAME=$(az acr list --resource-group rg-lpa-unified --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -z "$ACR_NAME" ]; then
            echo "ACR not found - will be created during infra deployment"
            echo "acr-exists=false" >> $GITHUB_OUTPUT
          else
            ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
            echo "acr-exists=true" >> $GITHUB_OUTPUT
            echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
            echo "name=$ACR_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Login to ACR
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        run: |
          az acr login --name ${{ steps.acr.outputs.name }}

      - name: Docker Meta
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.acr.outputs.login-server }}/halaxy-sync-worker
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push Docker Image
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./services/halaxy-sync-worker
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "‚úÖ HALAXY SYNC WORKER BUILD COMPLETE"
            echo "üê≥ Image: ${{ steps.meta.outputs.tags }}"
          else
            echo "‚úÖ HALAXY SYNC WORKER BUILD COMPLETE (TypeScript only)"
            echo "‚ö†Ô∏è Docker image not pushed - Azure credentials not configured"
            echo "üìù To enable Docker push, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 4: DEPLOY TO AZURE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Bloom Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-bloom-frontend:
    name: üöÄ Deploy Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-bloom-frontend, run-migrations]
    if: |
      always() &&
      needs.build-bloom-frontend.result == 'success' &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: artifact-download

      - name: Verify and Extract Artifacts
        run: |
          cd artifact-download
          sha256sum -c bloom-frontend-dist.tar.gz.sha256
          tar -xzf bloom-frontend-dist.tar.gz
          cp -r dist ../dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.bloom-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "‚úÖ BLOOM FRONTEND DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Website Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-website-frontend:
    name: üöÄ Deploy Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-website-frontend, run-migrations]
    if: |
      always() &&
      needs.build-website-frontend.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.website-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "‚úÖ WEBSITE FRONTEND DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Website API (Separate Azure Functions)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-website-api:
    name: üöÄ Deploy Website API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-website-api, run-migrations]
    if: |
      always() &&
      needs.build-website-api.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-api-${{ needs.determine-environment.outputs.environment }}
          path: website-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.website-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Website API publish profile not configured for this environment"
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.website-api-app }}
          package: website-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.website-api-secret] }}

      - name: Deployment Summary
        run: |
          if [ "${{ steps.check-secret.outputs.secret-exists }}" == "true" ]; then
            echo "‚úÖ WEBSITE API DEPLOYED"
            echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "üîó URL: https://${{ needs.determine-environment.outputs.website-api-app }}.azurewebsites.net"
          else
            echo "‚ö†Ô∏è WEBSITE API DEPLOYMENT SKIPPED"
            echo "üìù Configure WEBSITE_API_PUBLISH_PROFILE secret to enable deployment"
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Bloom API
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-bloom-api:
    name: üöÄ Deploy Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-bloom-api, run-migrations]
    if: |
      always() &&
      needs.build-bloom-api.result == 'success' &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: bloom-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.bloom-api-app }}
          package: bloom-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "‚úÖ BLOOM API DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Halaxy Sync Worker (Container Apps)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-halaxy-worker:
    name: üê≥ Deploy Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-halaxy-worker, run-migrations]
    if: |
      always() &&
      needs.build-halaxy-worker.result == 'success' &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Azure credentials not configured - skipping deployment"
            echo "üìù To enable deployment, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure (if needed)
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: infra
        run: |
          RG_NAME="rg-lpa-unified"
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          # Check if Container Apps environment exists
          CAE_EXISTS=$(az containerapp env list --resource-group $RG_NAME --query "[?name=='lpa-cae-${ENV_SHORT}'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$CAE_EXISTS" ]; then
            echo "üèóÔ∏è Deploying Container Apps infrastructure..."
            az deployment group create \
              --resource-group $RG_NAME \
              --template-file infra/halaxy-sync-worker.bicep \
              --parameters environment=${{ needs.determine-environment.outputs.environment }} \
              --parameters imageTag=${{ github.sha }}
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Infrastructure already exists"
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Container App
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Get ACR info
          ACR_NAME=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
          
          # Update container app with new image
          az containerapp update \
            --name $APP_NAME \
            --resource-group $RG_NAME \
            --image "${ACR_SERVER}/halaxy-sync-worker:${{ github.sha }}" \
            || echo "Container app may not exist yet - will be created by Bicep"

      - name: Verify Deployment
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Wait for container to be ready
          for i in {1..30}; do
            STATUS=$(az containerapp show --name $APP_NAME --resource-group $RG_NAME --query "properties.runningStatus" -o tsv 2>/dev/null || echo "NotFound")
            if [ "$STATUS" == "Running" ]; then
              echo "‚úÖ Container is running"
              break
            fi
            echo "Waiting for container to start... ($i/30)"
            sleep 10
          done

      - name: Deployment Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "‚úÖ HALAXY SYNC WORKER DEPLOYED"
            echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "üê≥ Container App: lpa-halaxy-sync-${{ needs.determine-environment.outputs.environment }}"
          else
            echo "‚ö†Ô∏è DEPLOYMENT SKIPPED - Azure credentials not configured"
            echo "üìù Build was successful, but deployment requires:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 5: DEPLOYMENT SUMMARY
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - detect-changes
      - run-migrations
      - deploy-bloom-frontend
      - deploy-bloom-api
      - deploy-website-frontend
      - deploy-website-api
      - deploy-halaxy-worker
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë        üå∏ LIFE PSYCHOLOGY DEPLOYMENT SUMMARY üå∏               ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üåç Environment:     ${{ needs.determine-environment.outputs.environment }}"
          echo "üìÖ Date:            $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîñ Commit:          ${{ github.sha }}"
          echo "üë§ Triggered by:    ${{ github.actor }}"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "CHANGES DETECTED"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üå∏ Bloom Frontend:  ${{ needs.detect-changes.outputs.bloom-frontend }}"
          echo "üîå Bloom API:       ${{ needs.detect-changes.outputs.bloom-api }}"
          echo "üîÑ Halaxy Worker:   ${{ needs.detect-changes.outputs.halaxy-worker }}"
          echo "üåê Website Frontend: ${{ needs.detect-changes.outputs.website-frontend }}"
          echo "‚ö° Website API:     ${{ needs.detect-changes.outputs.website-api }}"
          echo "üóÑÔ∏è Database:        ${{ needs.detect-changes.outputs.database }}"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "DEPLOYMENT STATUS"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üóÑÔ∏è Migrations:      ${{ needs.run-migrations.result }}"
          echo "üå∏ Bloom Frontend:  ${{ needs.deploy-bloom-frontend.result }}"
          echo "üîå Bloom API:       ${{ needs.deploy-bloom-api.result }}"
          echo "üîÑ Halaxy Worker:   ${{ needs.deploy-halaxy-worker.result }}"
          echo "üåê Website Frontend: ${{ needs.deploy-website-frontend.result }}"
          echo "‚ö° Website API:     ${{ needs.deploy-website-api.result }}"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "APPLICATION URLS"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üå∏ Bloom Portal:    https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "üîå Bloom API:       https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "üåê Website:         https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo ""

          # Check for failures (skipped is OK)
          MIGRATIONS="${{ needs.run-migrations.result }}"
          BLOOM_FE="${{ needs.deploy-bloom-frontend.result }}"
          BLOOM_API="${{ needs.deploy-bloom-api.result }}"
          WEBSITE_FE="${{ needs.deploy-website-frontend.result }}"
          WEBSITE_API="${{ needs.deploy-website-api.result }}"
          
          if [[ "$MIGRATIONS" == "failure" ]] || [[ "$BLOOM_FE" == "failure" ]] || \
             [[ "$BLOOM_API" == "failure" ]] || [[ "$WEBSITE_FE" == "failure" ]] || \
             [[ "$WEBSITE_API" == "failure" ]]; then
            echo "‚ùå DEPLOYMENT FAILED - See logs above"
            exit 1
          else
            echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          fi
