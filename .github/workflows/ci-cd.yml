# LIFE PSYCHOLOGY UNIFIED CI/CD WORKFLOW
# Combined Application Deployment + Database Migrations
# Last updated: 2025-12-06
#
# APPLICATIONS:
# 1. Bloom Portal (apps/bloom) + Bloom API (api/)
# 2. Website (apps/website) + Website API (apps/website/functions)
# 3. Halaxy DB Realtime Sync Service (api/src/services/halaxy/)
# 4. Database Migrations (db/migrations)
#
# ENVIRONMENTS:
# - Development (develop branch)
# - Staging (staging branch)
# - Production (main branch)
#
# TRIGGERS:
# - Auto-deploy on push to main/staging/develop
# - Smart change detection per app/db

name: CI/CD Pipeline

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
      - develop   # Development
      - hotfix    # Hotfix -> deploys to Staging
  pull_request:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      deploy_bloom:
        description: 'Deploy Bloom Portal'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy Website'
        required: false
        type: boolean
        default: true
      deploy_apis:
        description: 'Deploy APIs'
        required: false
        type: boolean
        default: true
      run_migrations:
        description: 'Run Database Migrations'
        required: false
        type: boolean
        default: true
      deploy_halaxy_sync:
        description: 'Deploy Halaxy Sync Service'
        required: false
        type: boolean
        default: true
      dry_run_migrations:
        description: 'Dry run migrations (preview only)'
        required: false
        type: boolean
        default: false

# Ensure only one workflow runs per branch at a time
# Cancel any in-progress runs when a new push happens
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 1: SETUP & ENVIRONMENT CONFIGURATION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Environment Configuration
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  determine-environment:
    name: üåç Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should-deploy: ${{ steps.config.outputs.should_deploy }}
      is-staging-validation: ${{ steps.config.outputs.is_staging_validation }}
      db-environment: ${{ steps.config.outputs.db_environment }}
      should-run-migrations: ${{ steps.detect-changes.outputs.db_changed }}
      # Bloom Portal
      bloom-frontend-app: ${{ steps.config.outputs.bloom_frontend_app }}
      bloom-api-app: ${{ steps.config.outputs.bloom_api_app }}
      bloom-frontend-secret: ${{ steps.config.outputs.bloom_frontend_secret }}
      bloom-api-secret: ${{ steps.config.outputs.bloom_api_secret }}
      bloom-api-url: ${{ steps.config.outputs.bloom_api_url }}
      # Website
      website-frontend-app: ${{ steps.config.outputs.website_frontend_app }}
      website-frontend-secret: ${{ steps.config.outputs.website_frontend_secret }}
    steps:
      - name: Checkout for change detection
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed to compare against push base
          
      - name: Detect database changes
        id: detect-changes
        run: |
          # Check if db/migrations or db/schema.sql changed in this push or if manual run_migrations is true
          if [ "${{ github.event.inputs.run_migrations }}" == "true" ]; then
            echo "db_changed=true" >> $GITHUB_OUTPUT
            echo "üìã Migrations requested via manual trigger"
          else
            # Use github.event.before to compare ALL commits in this push, not just HEAD~1
            # This catches migrations when multiple commits are pushed together
            BEFORE="${{ github.event.before }}"
            if [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
              # New branch - compare against default branch
              BEFORE="origin/${{ github.event.repository.default_branch }}"
            fi
            echo "üìã Comparing $BEFORE..HEAD for database changes"
            # Check for changes in db/migrations/ OR db/schema.sql (the source of truth)
            if git diff --name-only "$BEFORE" HEAD 2>/dev/null | grep -qE "^db/(migrations/|schema\.sql)"; then
              echo "db_changed=true" >> $GITHUB_OUTPUT
              echo "üìã Database changes detected in push"
            else
              echo "db_changed=false" >> $GITHUB_OUTPUT
              echo "üìã No database changes detected"
            fi
          fi
          
      - name: Set Environment Configuration
        id: config
        run: |
          REF="${{ github.ref }}"
          MANUAL_ENV="${{ github.event.inputs.environment }}"

          echo "üìç Branch/Ref: $REF"
          echo "üéØ Manual Override: $MANUAL_ENV"

          # Use manual input if workflow_dispatch, otherwise use branch
          if [ -n "$MANUAL_ENV" ]; then
            ENV="$MANUAL_ENV"
          else
            case "$REF" in
              refs/heads/main)
                ENV="production"
                ;;
              refs/heads/staging)
                ENV="staging"
                ;;
              refs/heads/hotfix)
                ENV="staging"
                ;;
              refs/heads/develop)
                ENV="development"
                ;;
              refs/pull/*)
                ENV="preview"
                ;;
              *)
                ENV="preview"
                ;;
            esac
          fi

          # Database environment mapping (staging uses dev DBs)
          IS_STAGING_VALIDATION="false"
          case "$ENV" in
            production)
              DB_ENV="prod"
              ;;
            staging)
              DB_ENV="dev"
              IS_STAGING_VALIDATION="true"
              ;;
            *)
              DB_ENV="dev"
              ;;
          esac

          # Set resource names based on environment
          case "$ENV" in
            production)
              BLOOM_FRONTEND_APP="lpa-bloom-prod"
              BLOOM_API_APP="bloom-functions-prod"
              BLOOM_API_URL="https://bloom-functions-prod.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD"
              BLOOM_API_SECRET="BLOOM_PROD_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-prod"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD"
              SHOULD_DEPLOY="true"
              ;;
            staging)
              BLOOM_FRONTEND_APP="lpa-bloom-staging"
              BLOOM_API_APP="bloom-functions-staging-new"
              BLOOM_API_URL="https://bloom-functions-staging-new.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING"
              BLOOM_API_SECRET="BLOOM_STAGING_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-staging"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING"
              SHOULD_DEPLOY="true"
              ;;
            development)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV"
              BLOOM_API_SECRET="BLOOM_DEV_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV"
              SHOULD_DEPLOY="true"
              ;;
            preview)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET=""
              BLOOM_API_SECRET=""
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_FRONTEND_SECRET=""
              SHOULD_DEPLOY="false"
              ;;
          esac

          # Output configuration
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_staging_validation=$IS_STAGING_VALIDATION" >> $GITHUB_OUTPUT
          echo "db_environment=$DB_ENV" >> $GITHUB_OUTPUT
          
          # Bloom Portal
          echo "bloom_frontend_app=$BLOOM_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_app=$BLOOM_API_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_url=$BLOOM_API_URL" >> $GITHUB_OUTPUT
          echo "bloom_frontend_secret=$BLOOM_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "bloom_api_secret=$BLOOM_API_SECRET" >> $GITHUB_OUTPUT
          
          # Website
          echo "website_frontend_app=$WEBSITE_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "website_frontend_secret=$WEBSITE_FRONTEND_SECRET" >> $GITHUB_OUTPUT

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ ENVIRONMENT CONFIGURATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üåç Environment:         $ENV"
          echo "üóÑÔ∏è DB Environment:      $DB_ENV"
          echo "üöÄ Should Deploy:       $SHOULD_DEPLOY"
          echo "üîÑ Staging Validation:  $IS_STAGING_VALIDATION"
          echo ""
          echo "üå∏ Bloom Frontend:      $BLOOM_FRONTEND_APP"
          echo "üîå Bloom API:           $BLOOM_API_APP"
          echo "üåê Website Frontend:    $WEBSITE_FRONTEND_APP"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Quality Checks (Run in Parallel)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  lint:
    name: üîç Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Root Dependencies
        run: npm ci
      - name: Run Root ESLint
        run: npm run lint
      - name: Install Website-Next Dependencies
        working-directory: apps/website-next
        run: npm ci
      - name: Run Website-Next ESLint
        working-directory: apps/website-next
        run: npm run lint

  type-check:
    name: üîç Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Root Dependencies
        run: npm ci
      - name: Install Bloom Dependencies
        working-directory: apps/bloom
        run: npm ci
      - name: Bloom Type Check
        working-directory: apps/bloom
        run: npx tsc --noEmit
      - name: Install Website-Next Dependencies
        working-directory: apps/website-next
        run: npm ci
      - name: Website-Next Type Check
        working-directory: apps/website-next
        run: npx tsc --noEmit

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 2: DATABASE MIGRATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Validate Migrations
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  validate-migrations:
    name: ‚úÖ Validate Migrations
    runs-on: ubuntu-latest
    needs: [determine-environment]
    if: needs.determine-environment.outputs.should-run-migrations == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Validate Migration Scripts
        run: |
          echo "üîç Validating migration scripts..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              echo "   Checking: $file"
              if grep -qi "DROP DATABASE" "$file"; then
                echo "‚ùå Error: DROP DATABASE found in $file"
                exit 1
              fi
              if grep -qi "TRUNCATE.*applications" "$file" && [ "${{ needs.determine-environment.outputs.db-environment }}" == "prod" ]; then
                echo "‚ö†Ô∏è Warning: TRUNCATE on applications table in production"
              fi
            fi
          done
          
          echo "‚úÖ All migration scripts validated"

      - name: Check Migration Naming Convention
        run: |
          echo "üîç Checking migration naming conventions..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if ! [[ "$filename" =~ ^V[0-9]+[a-z]?__[a-z0-9_]+\.sql$ ]]; then
                echo "‚ö†Ô∏è Warning: $filename doesn't follow naming convention V{version}__{description}.sql"
              fi
            fi
          done
          
          echo "‚úÖ Naming convention check complete"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Run Migrations
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  run-migrations:
    name: üóÑÔ∏è Run Migrations (${{ needs.determine-environment.outputs.db-environment }})
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-migrations, lint, type-check]
    if: |
      always() &&
      needs.validate-migrations.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.db-environment == 'prod' && 'production' || needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Connection Strings from Key Vault
        id: secrets
        run: |
          ENV_SUFFIX="${{ needs.determine-environment.outputs.db-environment == 'prod' && 'PROD' || 'DEV' }}"
          
          # Use the actual Key Vault name (includes random suffix from Bicep deployment)
          KV_NAME="lpa-kv-dev-i3u6u6psuu75o"
          
          SQL_CONN=$(az keyvault secret show \
            --name "SQL-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SQL_CONN" ]; then
            echo "SQL_CONNECTION_STRING=$SQL_CONN" >> $GITHUB_ENV
          fi
          
          COSMOS_CONN=$(az keyvault secret show \
            --name "COSMOS-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -n "$COSMOS_CONN" ]; then
            echo "DBVC_COSMOS_CONNECTION_STRING=$COSMOS_CONN" >> $GITHUB_ENV
          fi

      - name: Run Migrations
        id: migrate
        working-directory: db
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
          DRY_RUN: ${{ github.event.inputs.dry_run_migrations || github.event_name == 'pull_request' }}
        run: |
          echo "üöÄ Running database migrations for ${{ needs.determine-environment.outputs.db-environment }}..."
          
          # Install dependencies for migration script
          npm ci
          
          # First, repair any checksum mismatches from line-ending differences
          echo "üîß Repairing checksum mismatches (if any)..."
          node scripts/migrate.js repair-checksums || true
          
          # Run the proper incremental migration system
          if [ "$DRY_RUN" == "true" ]; then
            echo "üìã Dry run mode - showing migration info only"
            node scripts/migrate.js info
          else
            echo "üìã Applying pending migrations..."
            node scripts/migrate.js migrate
          fi
        continue-on-error: ${{ github.event.inputs.dry_run_migrations == 'true' || github.event_name == 'pull_request' }}

      - name: Extended Validation (Staging)
        if: |
          success() && 
          needs.determine-environment.outputs.is-staging-validation == 'true' && 
          github.event.inputs.dry_run_migrations != 'true' &&
          github.event_name != 'pull_request'
        working-directory: api
        env:
          SQL_CONNECTION_STRING: ${{ env.SQL_CONNECTION_STRING || secrets.SQL_CONNECTION_STRING }}
        run: |
          echo "üî¨ Running extended validation tests (staging branch - second pass)..."
          echo "üìã This validates migrations are safe to promote to production"
          
          # Simple validation - check schema_versions table
          cat > extended-validation.js << 'EOF'
          const sql = require('mssql');
          
          async function main() {
            let pool;
            try {
              pool = await sql.connect(process.env.SQL_CONNECTION_STRING);
              
              console.log('\nüî¨ EXTENDED VALIDATION SUITE');
              console.log('‚îÅ'.repeat(50));
              
              // Check schema_versions table
              const result = await pool.request().query(`
                SELECT version, description, applied_at, applied_by 
                FROM schema_versions 
                ORDER BY applied_at DESC
              `);
              
              console.log(`\nüìã Applied migrations: ${result.recordset.length}`);
              for (const row of result.recordset.slice(0, 5)) {
                console.log(`   ‚úÖ ${row.version}: ${row.description}`);
              }
              
              // Simple schema check
              const tablesResult = await pool.request().query(`
                SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES 
                WHERE TABLE_TYPE = 'BASE TABLE'
              `);
              console.log(`\nüìä Tables in database: ${tablesResult.recordset.length}`);
              
              console.log('\n' + '‚îÅ'.repeat(50));
              console.log('‚úÖ EXTENDED VALIDATION PASSED');
              
              await pool.close();
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Extended validation error:', error.message);
              if (pool) await pool.close();
              process.exit(1);
            }
          }
          
          main();
          EOF
          
          node extended-validation.js

      - name: Migration Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.migrate.outcome }}' === 'success';
            const environment = '${{ needs.determine-environment.outputs.db-environment }}';
            const dryRun = '${{ github.event.inputs.dry_run_migrations }}' === 'true' || '${{ github.event_name }}' === 'pull_request';
            
            const summary = `## üóÉÔ∏è Database Migration Summary
            
            | Property | Value |
            |----------|-------|
            | Environment | \`${environment}\` |
            | Dry Run | ${dryRun ? '‚úÖ Yes' : '‚ùå No'} |
            | Status | ${success ? '‚úÖ Success' : '‚ùå Failed'} |
            | Commit | \`${context.sha.substring(0, 7)}\` |
            `;
            
            await core.summary.addRaw(summary).write();

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Rollback on Failure (Production only)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  rollback-migrations:
    name: üîÑ Rollback Migrations (if needed)
    runs-on: ubuntu-latest
    needs: [determine-environment, run-migrations]
    if: |
      failure() && 
      needs.determine-environment.outputs.db-environment == 'prod' && 
      github.event.inputs.dry_run_migrations != 'true' &&
      github.event_name != 'pull_request'
    environment: production
    steps:
      - name: Rollback Alert
        run: |
          echo "‚ö†Ô∏è Production migration failed!"
          echo "Manual rollback may be required."

      - name: Create Issue for Failed Migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Migration Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Migration Failure
              
              A database migration failed in production.
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit:** ${context.sha}
              
              /cc @${context.actor}
              `,
              labels: ['bug', 'production', 'database', 'urgent']
            });

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 3: BUILD APPLICATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Bloom Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-bloom-frontend:
    name: üå∏ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Bloom Dependencies
        working-directory: apps/bloom
        run: npm ci

      - name: Build Bloom Application
        working-directory: apps/bloom
        env:
          MODE: ${{ needs.determine-environment.outputs.environment == 'production' && 'production' || 'development' }}
          # Single source of truth: VITE_API_URL (all other URLs derived in code)
          VITE_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
        run: |
          echo "üå∏ Building Bloom Frontend..."
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó API URL: $VITE_API_URL"
          npm run build -- --mode $MODE
          echo "‚úÖ Build complete"

      - name: Verify Build Output
        working-directory: apps/bloom
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå dist/index.html not found!"
            exit 1
          fi
          echo "‚úÖ Build verified"

      - name: Package Artifacts
        working-directory: apps/bloom
        run: |
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            apps/bloom/bloom-frontend-dist.tar.gz
            apps/bloom/bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Website Frontend (Next.js)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-website-frontend:
    name: üåê Build Website Frontend (Next.js)
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Website Dependencies
        working-directory: apps/website-next
        run: npm ci

      - name: Build Next.js Application
        working-directory: apps/website-next
        run: |
          echo "üåê Building Website Frontend (Next.js Static Export)..."
          npm run build
          echo "‚úÖ Build complete"
        env:
          NEXT_PUBLIC_SITE_URL: https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net
          # Use test Stripe key for dev, live key for staging/prod
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ needs.determine-environment.outputs.environment == 'development' && secrets.STRIPE_PUBLISHABLE_KEY_TEST || secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          # Single source of truth: NEXT_PUBLIC_API_URL (all other URLs derived in code)
          NEXT_PUBLIC_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}

      - name: Copy Static Web App Config
        run: |
          cp apps/website-next/staticwebapp.config.json apps/website-next/out/
          echo "‚úÖ staticwebapp.config.json copied to output"

      - name: Verify Build Output
        run: |
          if [ ! -f "apps/website-next/out/index.html" ]; then
            echo "‚ùå Build failed - index.html not found!"
            exit 1
          fi
          # Count generated pages
          PAGE_COUNT=$(find apps/website-next/out -name "index.html" | wc -l)
          echo "‚úÖ Build verified - $PAGE_COUNT pages generated"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website-next/out/
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Bloom API
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-bloom-api:
    name: üîå Build Bloom API (incl. Halaxy Sync)
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install API Dependencies
        working-directory: ./api
        run: npm ci

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "üîå Building Bloom API..."
          npm run build
          echo "‚úÖ API build complete"

      - name: Verify Function Registration
        working-directory: ./api
        run: |
          echo "üîç Verifying all functions are registered..."
          node verify-function-registration.js
          echo "‚úÖ Function registration verified"

      - name: Verify Halaxy Sync Service
        working-directory: ./api
        run: |
          echo "üîÑ Verifying Halaxy Sync Service compilation..."
          if [ -f "dist/services/halaxy/sync-service.js" ]; then
            echo "‚úÖ Halaxy Sync Service compiled successfully"
          else
            echo "‚ùå Halaxy Sync Service not found in build output!"
            exit 1
          fi
          
          # Verify all Halaxy service files
          for file in client index transformers token-manager types; do
            if [ -f "dist/services/halaxy/${file}.js" ]; then
              echo "  ‚úì halaxy/${file}.js"
            else
              echo "  ‚úó halaxy/${file}.js MISSING"
              exit 1
            fi
          done
          
          echo "‚úÖ All Halaxy Sync Service modules verified"

      - name: Verify Build Output
        working-directory: ./api
        run: |
          echo "üîç Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "‚ùå dist/ folder not found!"
            exit 1
          fi
          
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå dist/index.js not found!"
            exit 1
          fi
          
          if [ ! -d "dist/functions" ]; then
            echo "‚ùå dist/functions/ folder not found!"
            exit 1
          fi
          
          echo "üìÅ dist/ contents:"
          ls -la dist/
          echo "üìÅ dist/functions/ contents:"
          ls -la dist/functions/
          
          # Count functions
          FUNC_COUNT=$(ls -1 dist/functions/*.js 2>/dev/null | wc -l)
          echo "‚úÖ Found ${FUNC_COUNT} function files"
          
          if [ "$FUNC_COUNT" -eq 0 ]; then
            echo "‚ùå No function .js files found in dist/functions/"
            exit 1
          fi

      - name: Package Bloom API
        working-directory: ./api
        run: |
          echo "üì¶ Creating deploy package..."
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copy compiled output
          cp -r dist/* deploy-package/
          
          # Copy required config files
          cp host.json deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Update package.json for deployment:
          # 1. Change main entry point from dist/index.js to index.js
          # 2. Remove build script - code is already compiled
          cd deploy-package
          sed -i 's|"main": "dist/index.js"|"main": "index.js"|' package.json
          sed -i 's|"build": "tsc"|"build": "echo Code already compiled"|' package.json
          sed -i 's|"prestart": "npm run build",||' package.json
          
          # Verify the package.json changes
          echo "üìÑ Updated package.json scripts:"
          grep -A5 '"scripts"' package.json
          
          # Install production dependencies (required since we disabled remote build)
          echo "üì¶ Installing production dependencies..."
          npm ci --production --ignore-scripts
          
          # Verify package contents
          echo "üìÅ deploy-package/ contents:"
          ls -la
          echo "üìÅ deploy-package/functions/ contents:"
          ls -la functions/
          echo "üìÅ deploy-package/node_modules/ (first 10):"
          ls node_modules/ | head -10
          
          echo "‚úÖ Package ready with node_modules included"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Build Halaxy Sync Worker (Container Apps)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  build-halaxy-worker:
    name: üê≥ Build Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    # Temporarily disabled - uncomment the condition below to re-enable
    if: false
    # if: |
    #   always() &&
    #   needs.determine-environment.outputs.should-deploy == 'true' &&
    #   needs.lint.result == 'success' &&
    #   needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Azure credentials not configured - skipping ACR push"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/halaxy-sync-worker/package-lock.json

      - name: Install Worker Dependencies
        working-directory: ./services/halaxy-sync-worker
        run: npm ci

      - name: Build Worker
        working-directory: ./services/halaxy-sync-worker
        run: |
          echo "üê≥ Building Halaxy Sync Worker..."
          npm run build
          echo "‚úÖ Build complete"

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR Login Server
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: acr
        run: |
          ACR_NAME=$(az acr list --resource-group rg-lpa-unified --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -z "$ACR_NAME" ]; then
            echo "ACR not found - will be created during infra deployment"
            echo "acr-exists=false" >> $GITHUB_OUTPUT
          else
            ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
            echo "acr-exists=true" >> $GITHUB_OUTPUT
            echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
            echo "name=$ACR_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Login to ACR
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        run: |
          az acr login --name ${{ steps.acr.outputs.name }}

      - name: Docker Meta
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.acr.outputs.login-server }}/halaxy-sync-worker
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and Push Docker Image
        if: steps.check-creds.outputs.has-azure-creds == 'true' && steps.acr.outputs.acr-exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./services/halaxy-sync-worker
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Build Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "‚úÖ HALAXY SYNC WORKER BUILD COMPLETE"
            echo "üê≥ Image: ${{ steps.meta.outputs.tags }}"
          else
            echo "‚úÖ HALAXY SYNC WORKER BUILD COMPLETE (TypeScript only)"
            echo "‚ö†Ô∏è Docker image not pushed - Azure credentials not configured"
            echo "üìù To enable Docker push, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 4: DEPLOY TO AZURE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Bloom Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-bloom-frontend:
    name: üöÄ Deploy Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-frontend]
    if: |
      always() &&
      needs.build-bloom-frontend.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: artifact-download

      - name: Verify and Extract Artifacts
        run: |
          cd artifact-download
          sha256sum -c bloom-frontend-dist.tar.gz.sha256
          tar -xzf bloom-frontend-dist.tar.gz
          cp -r dist ../dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.bloom-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true
          production_branch: ${{ github.ref_name }}

      - name: Deployment Summary
        run: |
          echo "‚úÖ BLOOM FRONTEND DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Website Frontend
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-website-frontend:
    name: üöÄ Deploy Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-website-frontend]
    if: |
      always() &&
      needs.build-website-frontend.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.website-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "‚úÖ WEBSITE FRONTEND DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Bloom API
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-bloom-api:
    name: üöÄ Deploy Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-api]
    if: |
      always() &&
      needs.build-bloom-api.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: bloom-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.bloom-api-app }}
          package: bloom-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}
          scm-do-build-during-deployment: false
          enable-oryx-build: false

      - name: Login to Azure
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure Halaxy App Settings
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "üîß Configuring Halaxy environment variables..."
          
          # Get Halaxy credentials from Key Vault
          KV_NAME="lpa-kv-dev-i3u6u6psuu75o"
          
          HALAXY_CLIENT_ID=$(az keyvault secret show \
            --name "HALAXY-CLIENT-ID" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          HALAXY_CLIENT_SECRET=$(az keyvault secret show \
            --name "HALAXY-CLIENT-SECRET" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          HALAXY_ORG_ID=$(az keyvault secret show \
            --name "HALAXY-ORGANIZATION-ID" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          HALAXY_API_URL=$(az keyvault secret show \
            --name "HALAXY-API-URL" \
            --vault-name "$KV_NAME" \
            --query value -o tsv 2>/dev/null || echo "")
          
          if [ -z "$HALAXY_CLIENT_ID" ] || [ -z "$HALAXY_CLIENT_SECRET" ]; then
            echo "‚ùå Failed to retrieve Halaxy credentials from Key Vault"
            exit 1
          fi
          
          echo "‚úÖ Retrieved Halaxy credentials from Key Vault"
          
          az functionapp config appsettings set \
            --name ${{ needs.determine-environment.outputs.bloom-api-app }} \
            --resource-group rg-lpa-unified \
            --settings \
              HALAXY_CLIENT_ID="$HALAXY_CLIENT_ID" \
              HALAXY_CLIENT_SECRET="$HALAXY_CLIENT_SECRET" \
              HALAXY_ORGANIZATION_ID="$HALAXY_ORG_ID" \
              HALAXY_FHIR_URL="$HALAXY_API_URL" \
            --output none
          echo "‚úÖ Halaxy app settings configured"

      - name: Sync Function Triggers
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "üîÑ Waiting for deployment to settle..."
          sleep 15
          
          # Extract credentials from publish profile
          PUBLISH_PROFILE='${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}'
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | sed 's/userName="//')
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | sed 's/userPWD="//')
          
          echo "üîÑ Triggering function sync..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/functions/synctriggers" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 60 || echo "‚ö†Ô∏è Sync trigger request completed (may have timed out)"
          
          echo "üîÑ Restarting function app to ensure functions are loaded..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/restart" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 30 || echo "‚ö†Ô∏è Restart request sent"
          
          sleep 10
          echo "‚úÖ Function sync and restart complete"

      - name: Trigger Halaxy Sync
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "üîÑ Waiting for function app to be fully ready..."
          sleep 20
          
          echo "üîÑ Triggering Halaxy sync to populate availability data..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net/api/halaxy/sync" \
            -H "Content-Type: application/json" \
            --silent --show-error --max-time 120 \
            -w "\nüìä HTTP Status: %{http_code}\n" || echo "‚ö†Ô∏è Sync trigger request completed"
          
          echo "‚úÖ Halaxy sync triggered successfully"

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "‚úÖ BLOOM API DEPLOYED"
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üîó URL: https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "üîÑ Halaxy Sync: Triggered automatically"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Deploy Halaxy Sync Worker (Container Apps)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  deploy-halaxy-worker:
    name: üê≥ Deploy Halaxy Sync Worker
    runs-on: ubuntu-latest
    needs: [determine-environment, build-halaxy-worker]
    # Temporarily disabled - uncomment the condition below to re-enable
    if: false
    # if: |
    #   always() &&
    #   needs.build-halaxy-worker.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Check Azure Credentials
        id: check-creds
        run: |
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has-azure-creds=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Azure credentials are configured"
          else
            echo "has-azure-creds=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Azure credentials not configured - skipping deployment"
            echo "üìù To enable deployment, add these secrets to your repository:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

      - name: Azure Login
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Container App
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Wait for the container app to exist (Bicep may still be provisioning)
          echo "‚è≥ Waiting for container app $APP_NAME to exist..."
          for i in {1..30}; do
            if az containerapp show --name "$APP_NAME" --resource-group "$RG_NAME" --query "name" -o tsv 2>/dev/null; then
              echo "‚úÖ Container app exists"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "‚ùå Timed out waiting for container app $APP_NAME"
              exit 1
            fi
            echo "   Attempt $i/30 - container app not found, retrying in 10s..."
            sleep 10
          done
          
          # Get ACR info
          ACR_NAME=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
          
          # Use short SHA (7 chars) to match docker/metadata-action tag format
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          
          # Update container app with new image (fail the job on error)
          az containerapp update \
            --name $APP_NAME \
            --resource-group $RG_NAME \
            --image "${ACR_SERVER}/halaxy-sync-worker:${SHORT_SHA}"

      - name: Verify Deployment
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          # Wait for container to be ready
          for i in {1..30}; do
            STATUS=$(az containerapp show --name $APP_NAME --resource-group $RG_NAME --query "properties.runningStatus" -o tsv 2>/dev/null || echo "NotFound")
            if [ "$STATUS" == "Running" ]; then
              echo "‚úÖ Container is running"
              break
            fi
            echo "Waiting for container to start... ($i/30)"
            sleep 10
          done

      - name: Verify Container Health
        if: steps.check-creds.outputs.has-azure-creds == 'true'
        continue-on-error: true  # Don't fail deployment if health check times out
        run: |
          FULL_ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Map full environment name to short name for resource naming
          case "$FULL_ENV" in
            production) ENV_SHORT="prod" ;;
            staging) ENV_SHORT="staging" ;;
            *) ENV_SHORT="dev" ;;
          esac
          
          APP_NAME="lpa-halaxy-sync-${ENV_SHORT}"
          RG_NAME="rg-lpa-unified"
          
          echo "‚ÑπÔ∏è  Note: Halaxy sync worker is a placeholder service"
          echo "‚ÑπÔ∏è  It provides health checks and infrastructure but does not sync data"
          echo "‚ÑπÔ∏è  Data is fetched directly from Halaxy public APIs at request time"
          
          # Just verify the container is healthy
          echo "üîç Checking container health..."
          
          for i in {1..6}; do
            STATUS=$(az containerapp show --name $APP_NAME --resource-group $RG_NAME --query "properties.runningStatus" -o tsv 2>/dev/null || echo "NotFound")
            
            if [ "$STATUS" == "Running" ]; then
              echo "‚úÖ Container is running and healthy"
              exit 0
            fi
            
            if [ "$i" -eq 6 ]; then
              echo "‚ö†Ô∏è Container status: $STATUS"
              echo "üìù This is informational only - deployment can proceed"
              exit 0
            fi
            
            echo "   Status: $STATUS - checking again in 10s ($i/6)..."
            sleep 10
          done

      - name: Deployment Summary
        run: |
          if [ "${{ steps.check-creds.outputs.has-azure-creds }}" == "true" ]; then
            echo "‚úÖ HALAXY SYNC WORKER DEPLOYED"
            echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
            echo "üê≥ Container App: lpa-halaxy-sync-${{ needs.determine-environment.outputs.environment }}"
          else
            echo "‚ö†Ô∏è DEPLOYMENT SKIPPED - Azure credentials not configured"
            echo "üìù Build was successful, but deployment requires:"
            echo "   - AZURE_CLIENT_ID"
            echo "   - AZURE_TENANT_ID"
            echo "   - AZURE_SUBSCRIPTION_ID"
          fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# STAGE 5: DEPLOYMENT SUMMARY
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - run-migrations
      - deploy-bloom-frontend
      - deploy-bloom-api
      - deploy-website-frontend
      - deploy-halaxy-worker
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë        üå∏ LIFE PSYCHOLOGY DEPLOYMENT SUMMARY üå∏               ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üåç Environment:     ${{ needs.determine-environment.outputs.environment }}"
          echo "üìÖ Date:            $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîñ Commit:          ${{ github.sha }}"
          echo "üë§ Triggered by:    ${{ github.actor }}"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "DEPLOYMENT STATUS"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üóÑÔ∏è Migrations:      ${{ needs.run-migrations.result }}"
          echo "üå∏ Bloom Frontend:  ${{ needs.deploy-bloom-frontend.result }}"
          echo "üîå Bloom API:       ${{ needs.deploy-bloom-api.result }}"
          echo "üîÑ Halaxy Worker:   ${{ needs.deploy-halaxy-worker.result }}"
          echo "üåê Website Frontend: ${{ needs.deploy-website-frontend.result }}"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "APPLICATION URLS"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üå∏ Bloom Portal:    https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "üîå Bloom API:       https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "üåê Website:         https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo ""

          # Check for failures (skipped is OK)
          MIGRATIONS="${{ needs.run-migrations.result }}"
          BLOOM_FE="${{ needs.deploy-bloom-frontend.result }}"
          BLOOM_API="${{ needs.deploy-bloom-api.result }}"
          WEBSITE_FE="${{ needs.deploy-website-frontend.result }}"
          
          if [[ "$MIGRATIONS" == "failure" ]] || [[ "$BLOOM_FE" == "failure" ]] || \
             [[ "$BLOOM_API" == "failure" ]] || [[ "$WEBSITE_FE" == "failure" ]]; then
            echo "‚ùå DEPLOYMENT FAILED - See logs above"
            exit 1
          else
            echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          fi
