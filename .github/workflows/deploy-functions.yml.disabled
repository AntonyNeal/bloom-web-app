name: Deploy Azure Functions

on:
  # Automatic deployment disabled - use manual workflow_dispatch only
  # push:
  #   paths:
  #     - 'functions/**'
  #     - '.github/workflows/deploy-functions.yml'
  workflow_dispatch:
    inputs:
      function_name:
        description: 'Specific function to deploy (leave empty to deploy all functions)'
        required: false

env:
  NODE_VERSION: '18.x'
  AZURE_FUNCTIONAPP_NAME: 'fnt42kldozqahcu'

jobs:
  detect-changes:
    name: Detect Changed Functions
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.detect.outputs.functions }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed functions
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - always deploy all functions
            if [ -n "${{ github.event.inputs.function_name }}" ]; then
              # Specific function requested
              echo "functions=[\"${{ github.event.inputs.function_name }}\"]" >> $GITHUB_OUTPUT
              echo "Manual deployment requested for: ${{ github.event.inputs.function_name }}"
            else
              # Deploy all functions
              echo "functions=[\"submit\",\"get-sas-token\"]" >> $GITHUB_OUTPUT
              echo "Manual deployment requested for all functions"
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Automatic detection of changed functions
            changed_files=$(git diff --name-only HEAD~1 HEAD -- functions/)

            if [ -z "$changed_files" ]; then
              echo "No function changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "functions=[]" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Extract unique function directories
            functions=$(echo "$changed_files" | \
              grep -E '^functions/applications/' | \
              cut -d'/' -f3 | \
              sort -u | \
              jq -R -s -c 'split("\n") | map(select(length > 0))')

            if [ "$functions" == "[]" ] || [ -z "$functions" ]; then
              # Changes in functions root (package.json, tsconfig, etc.) - deploy all
              echo "Root-level changes detected, deploying all functions"
              functions='["submit","get-sas-token"]'
            fi

            echo "functions=$functions" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed functions: $functions"
          fi

  build-and-test:
    name: Build & Test
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        working-directory: functions
        run: npm ci

      - name: Build TypeScript
        working-directory: functions
        run: npm run build

      - name: Run tests (if exist)
        working-directory: functions
        run: npm test --if-present
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: |
            functions/
            !functions/node_modules/
          retention-days: 1

  test-halaxy-api:
    name: Test Halaxy API Integration
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: azure-functions-project
        run: npm ci

      - name: Create local.settings.json from secrets
        working-directory: azure-functions-project
        run: |
          cat > local.settings.json << EOF
          {
            "IsEncrypted": false,
            "Values": {
              "AzureWebJobsStorage": "UseDevelopmentStorage=true",
              "FUNCTIONS_WORKER_RUNTIME": "node",
              "FUNCTIONS_WORKER_RUNTIME_VERSION": "18",
              "SQL_SERVER": "${{ secrets.SQL_SERVER }}",
              "SQL_DATABASE": "${{ secrets.SQL_DATABASE }}",
              "SQL_USER": "${{ secrets.SQL_USER }}",
              "SQL_ADMIN_PASSWORD": "${{ secrets.SQL_ADMIN_PASSWORD }}",
              "GA4_API_SECRET": "${{ secrets.GA4_API_SECRET }}",
              "HALAXY_CLIENT_ID": "${{ secrets.HALAXY_CLIENT_ID }}",
              "HALAXY_CLIENT_SECRET": "${{ secrets.HALAXY_CLIENT_SECRET }}",
              "HALAXY_ORGANIZATION_ID": "${{ secrets.HALAXY_ORGANIZATION_ID }}",
              "HALAXY_PRACTITIONER_ROLE_ID": "${{ secrets.HALAXY_PRACTITIONER_ROLE_ID }}",
              "HALAXY_BASE_URL": "https://au-api.halaxy.com/main"
            }
          }
          EOF

      - name: Run Halaxy API tests
        working-directory: azure-functions-project
        run: npm test
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: halaxy-test-results
          path: azure-functions-project/coverage/
          retention-days: 7

  deploy-functions:
    name: Deploy to Azure
    needs: [detect-changes, build-and-test, test-halaxy-api]
    if: |
      needs.detect-changes.outputs.has_changes == 'true' &&
      needs.test-halaxy-api.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: functions

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription 47b5552f-0eb8-4462-97e7-cd67e8e660b8
          echo "Current subscription:"
          az account show --query "[name,id]" -o tsv

      - name: Verify Function App Access
        run: |
          echo "Checking Function App access..."
          az functionapp show --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group rg-lpa-prod-opt --query "[name,location,state]" -o table

      - name: Install production dependencies
        working-directory: functions
        run: npm ci --production

      - name: Deploy to Azure Function App
        working-directory: functions
        run: |
          echo "Starting deployment..."
          func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --typescript --verbose

      - name: Set Azure Function App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          app-settings-json: |
            [
              {
                "name": "AZURE_STORAGE_ACCOUNT_NAME",
                "value": "${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}",
                "slotSetting": false
              },
              {
                "name": "AZURE_STORAGE_ACCOUNT_KEY",
                "value": "${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}",
                "slotSetting": false
              },
              {
                "name": "ADMIN_EMAIL",
                "value": "admin@life-psychology.com.au",
                "slotSetting": false
              },
              {
                "name": "WEBSITE_RUN_FROM_PACKAGE",
                "value": "1",
                "slotSetting": false
              }
            ]

      - name: Azure Logout
        if: always()
        run: az logout

  notify-deployment:
    name: Notify Deployment
    needs: [detect-changes, deploy-functions]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "### Azure Functions Deployment ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Functions Changed:** ${{ needs.detect-changes.outputs.functions }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy-functions.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function App URL:** https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
