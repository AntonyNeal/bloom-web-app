# CI/CD Pipeline workflow
# Required for code scanning SARIF upload

 # CI/CD Pipeline workflow
 # Required for code scanning SARIF upload

permissions:
  actions: read
  contents: read
  security-events: write
name: CI/CD Pipeline

on:
  push:
    branches: [main, staging, develop, 'feature/**', 'bugfix/**', 'hotfix/**']
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run automated tests'
        required: false
        type: boolean
        default: false
      deployment_reason:
        description: 'Reason for manual deployment'
        required: false
        type: string
        default: 'Manual deployment trigger'

# Environment matrix for different branches
env:
  NODE_VERSION: '20'
  # Default debug panel setting for builds (can be overridden via repo vars)
  VITE_DEBUG_PANEL: 'false'

jobs:
  # PARALLEL QUALITY CHECKS (all run simultaneously)
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run format:check

  type-check:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run type-check

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=moderate || true # Don't fail on audit
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          format: sarif
          output: trivy-results.sarif

    # DETERMINE ENVIRONMENT BASED ON BRANCH
  determine-environment:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      app-name: ${{ steps.set-env.outputs.app-name }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
      should-test: ${{ steps.set-env.outputs.should-test }}
    steps:
      - name: Print all environment variables
        run: |
          echo "üìã === ALL ENVIRONMENT VARIABLES ==="
          printenv | sort
          echo ""
      - name: Determine environment and deployment settings based on branch
        id: set-env
        run: |
          echo "üîç Analyzing branch: ${{ github.ref }}"
          echo "üìã Branch name: ${{ github.ref_name }}"
          echo ""

          case "${{ github.ref }}" in
            "refs/heads/develop")
              echo "‚úÖ Matched: develop branch"
              echo "üéØ Target Environment: development"
              echo "üèóÔ∏è App Name: lpa-frontend-dev"
              echo "üöÄ Should Deploy: true"
              echo "üß™ Should Test: false"
              echo ""
              echo "environment=development" >> $GITHUB_OUTPUT
              echo "app-name=lpa-frontend-dev" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "should-test=false" >> $GITHUB_OUTPUT
              ;;
            "refs/heads/staging")
              echo "‚úÖ Matched: staging branch"
              echo "üéØ Target Environment: staging"
              echo "üèóÔ∏è App Name: lpa-frontend-staging"
              echo "üöÄ Should Deploy: true"
              echo "üß™ Should Test: true"
              echo ""
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "app-name=lpa-frontend-staging" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "should-test=true" >> $GITHUB_OUTPUT
              ;;
            "refs/heads/main")
              echo "‚úÖ Matched: main branch"
              echo "üéØ Target Environment: production"
              echo "üèóÔ∏è App Name: lpa-frontend-prod"
              echo "üöÄ Should Deploy: true"
              echo "üß™ Should Test: true"
              echo ""
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "app-name=lpa-frontend-prod" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "should-test=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "‚ö†Ô∏è No specific match found for branch: ${{ github.ref_name }}"
              echo "üéØ Defaulting to: development environment"
              echo "üèóÔ∏è App Name: lpa-frontend-dev"
              echo "üöÄ Should Deploy: false"
              echo "üß™ Should Test: false"
              echo ""
              echo "environment=development" >> $GITHUB_OUTPUT
              echo "app-name=lpa-frontend-dev" >> $GITHUB_OUTPUT
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "should-test=false" >> $GITHUB_OUTPUT
              ;;
          esac

          echo ""
          echo "üì§ Job outputs set:"
          echo "  - environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d'=' -f2)"
          echo "  - app-name: $(cat $GITHUB_OUTPUT | grep app-name | cut -d'=' -f2)"
          echo "  - should-deploy: $(cat $GITHUB_OUTPUT | grep should-deploy | cut -d'=' -f2)"
          echo "  - should-test: $(cat $GITHUB_OUTPUT | grep should-test | cut -d'=' -f2)"

  # PRINT GITHUB ENVIRONMENT VARIABLES
  print-env-vars:
    name: Print GitHub Environment Variables
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Print GitHub environment variables
        run: |
          echo "üåç === GITHUB ENVIRONMENT VARIABLES ==="
          echo "üéØ Target Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "üèóÔ∏è App Name: ${{ needs.determine-environment.outputs.app-name }}"
          echo ""

          echo "üìã === ALL ENVIRONMENT VARIABLES ==="
          printenv | sort
          echo ""

          echo "üéØ === GITHUB ENVIRONMENT SPECIFIC VARIABLES ==="
          echo "Available environment variables are set in repository settings (not printed for security)."
          echo "Determined environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "AZURE_STATIC_WEB_APPS_API_TOKEN: *** (hidden for security)"
          echo ""

          echo "‚úÖ Environment variables loaded successfully from GitHub environment: ${{ needs.determine-environment.outputs.environment }}"

  # CONDITIONAL TESTS (only for staging/production)
  run-tests:
    name: Run Test Suite
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should-test == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }} # Uncommented to use environment-specific secrets
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Build application for testing
        run: npm run build
      - name: Start preview server
        run: npm run preview -- --port 5174 --host 0.0.0.0 &
      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start on http://localhost:5174..."
          timeout 120 bash -c 'until curl -f http://localhost:5174 > /dev/null 2>&1; do sleep 2; echo "Still waiting..."; done' || (echo "Server failed to start after 2 minutes" && exit 1)
          echo "‚úÖ Server is ready!"
      - name: Run Playwright End to End tests
        run: npm run test:prestaging
        env:
          DEBUG: pw:api
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: playwright-report/
          retention-days: 7

  # BUILD APPLICATION
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [determine-environment, print-env-vars, lint, type-check, security]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }} # Uncommented to use environment-specific secrets
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Build Application
        run: |
          echo "Building application (target environment provided by previous job)..."
          echo "üîç Note: Runtime secrets are intentionally NOT provided to the build step."
          echo "‚úÖ Starting build (no runtime secrets)."

          npm run build:ci
          echo "‚úÖ Build finished. dist/ created."
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          retention-days: 1

      - name: Upload raw dist/index.html (pre-inject) for debugging
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dist-index-pre-inject
          path: dist/index.html
          retention-days: 3

      - name: Export runtime variables to GITHUB_ENV (for injector step)
        if: always()
        run: |
          echo "Exporting minimal runtime vars into GITHUB_ENV for injector"
          # Only export build iteration and a timestamp (avoid referencing repo vars directly to satisfy linter)
          echo "VITE_BUILD_ITERATION=${{ github.run_number }}" >> $GITHUB_ENV
          # compute ISO UTC timestamp locally to avoid context linter warnings
          echo "VITE_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          # Set OpenAI key from secrets; support two possible secret names
          if [ -n "${{ secrets.VITE_OPENAI_API_KEY }}" ]; then
            echo "VITE_OPENAI_API_KEY=${{ secrets.VITE_OPENAI_API_KEY }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "VITE_OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          fi

      - name: Inject runtime envs into built index.html (committed injector)
        if: always()
        run: |
          echo "Injecting runtime environment variables into dist/index.html"
          echo "Note: This step receives runtime secrets; they are NOT available to the previous build step."
          # Allow injector to fail the job if required replacements are missing
          export FAIL_ON_MISSING=true
          # Tighten required keys to ensure critical runtime values are present
          export REQUIRED_KEYS=VITE_GTM_ID,VITE_OPENAI_API_KEY,VITE_BUILD_ITERATION,VITE_BUILD_TIME
          node scripts/inject-runtime-envs.cjs
        env:
          # Sensitive values from secrets only
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}

      - name: Upload injected dist/index.html for debugging
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dist-index-post-inject
          path: dist/index.html
          retention-days: 7

      - name: Upload full dist for debugging (post-inject)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dist-full-post-inject
          path: dist
          retention-days: 7

      - name: Verify no placeholder tokens remain
        run: |
          echo "Verifying dist/index.html for unresolved placeholders..."
          # Check both legacy and runtime token patterns
          if grep -q '%VITE_' dist/index.html || grep -q '__RUNTIME_VITE_' dist/index.html; then
            echo "‚ùå Placeholder tokens remain in dist/index.html"
            echo "Listing matches (legacy %VITE_...%):"
            grep -n '%VITE_' dist/index.html || true
            echo "Listing matches (runtime __RUNTIME_VITE_...__):"
            grep -n '__RUNTIME_VITE_' dist/index.html || true
            exit 1
          fi
          echo "‚úÖ No placeholders remain"

  # DEPLOY APPLICATION
  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, print-env-vars, build]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }} # Uncommented to use environment-specific secrets
    steps:
      - uses: actions/checkout@v4
      - name: Set deployment token
        run: echo "DEPLOY_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '.'
          output_location: 'dist'
      - name: Post deployment notification
        run: |
          echo "‚úÖ Successfully deployed to ${{ needs.determine-environment.outputs.environment }} environment"
          echo "üåê Application URL: https://${{ needs.determine-environment.outputs.app-name }}.azurestaticapps.net"
