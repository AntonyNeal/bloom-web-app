name: Proto-Bloom CI/CD

on:
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  # QUALITY CHECKS (parallel)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit

  # DETECT CHANGES
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
      frontend-changed: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
            frontend:
              - 'src/**'
              - 'public/**'
              - 'index.html'
              - 'vite.config.ts'
              - 'package.json'
              - 'tsconfig.json'

  # DETERMINE ENVIRONMENT
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      app-name: ${{ steps.set-env.outputs.app-name }}
      should-deploy: ${{ steps.set-env.outputs.should-deploy }}
    steps:
      - name: Determine environment from branch
        id: set-env
        run: |
          REF="${{ github.ref }}"
          echo "Branch/Ref: $REF"
          
          case "$REF" in
            refs/heads/main)
              ENV="production"
              APP_NAME="lpa-proto-bloom"
              SHOULD_DEPLOY="true"
              ;;
            refs/heads/staging)
              ENV="staging"
              APP_NAME="lpa-proto-bloom"
              SHOULD_DEPLOY="true"
              ;;
            refs/heads/develop)
              ENV="development"
              APP_NAME="lpa-proto-bloom"
              SHOULD_DEPLOY="true"
              ;;
            *)
              ENV="preview"
              APP_NAME="lpa-proto-bloom"
              SHOULD_DEPLOY="false"
              ;;
          esac
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "app-name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "‚úÖ Environment: $ENV | App: $APP_NAME | Deploy: $SHOULD_DEPLOY"

  # BUILD APPLICATION
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      
      - name: Build Application
        run: |
          echo "Building Proto-Bloom application..."
          echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
          npm run build
          echo "‚úÖ Build finished"
        env:
          VITE_ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          retention-days: 7

  # BUILD AZURE FUNCTIONS API
  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, lint, type-check]
    if: |
      always() &&
      needs.detect-changes.outputs.api-changed == 'true' &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json
      
      - name: Install API dependencies
        working-directory: ./api
        run: npm ci
      
      - name: Build API
        working-directory: ./api
        run: |
          echo "Building Azure Functions API..."
          npm run build
          echo "‚úÖ API build finished"
      
      - name: Prepare API deployment package
        working-directory: ./api
        run: |
          echo "üì¶ Packaging API for deployment..."
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp host.json deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          echo "‚úÖ Deployment package ready"
      
      - name: Upload API artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-dist
          path: api/deploy-package
          retention-days: 7

  # DEPLOY APPLICATION
  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, build]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.build.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      
      - name: Verify build artifacts
        run: |
          echo "üîç Verifying build artifacts..."
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå dist/index.html not found!"
            exit 1
          fi
          echo "‚úÖ Build artifacts verified"
          ls -la dist/
      
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.BLOOM_AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '.'
          output_location: 'dist'
      
      - name: Post deployment notification
        run: |
          echo "‚úÖ Successfully deployed to ${{ needs.determine-environment.outputs.environment }} environment"
          echo "üåê Application URL: https://${{ needs.determine-environment.outputs.app-name }}.azurestaticapps.net"

  # DEPLOY AZURE FUNCTIONS API
  deploy-api:
    name: Deploy API to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-changes, build-api]
    if: |
      always() &&
      needs.detect-changes.outputs.api-changed == 'true' &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.build-api.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Download API artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-dist
          path: api-dist
      
      - name: Verify API artifacts
        run: |
          echo "üîç Verifying API artifacts..."
          ls -la api-dist/
          if [ ! -f "api-dist/host.json" ]; then
            echo "‚ùå host.json not found!"
            exit 1
          fi
          echo "‚úÖ API artifacts verified"
      
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: fnt42kldozqahcu
          package: api-dist
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          respect-funcignore: true
      
      - name: Post API deployment notification
        run: |
          echo "‚úÖ Successfully deployed API to ${{ needs.determine-environment.outputs.environment }} environment"
          echo "üîó API URL: https://fnt42kldozqahcu.azurewebsites.net"
