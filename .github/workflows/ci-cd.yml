# LIFE PSYCHOLOGY UNIFIED CI/CD WORKFLOW
# Combined Application Deployment + Database Migrations
# Last updated: 2025-12-23
#
# APPLICATIONS:
# 1. Bloom Portal (apps/bloom) + Bloom API (api/)
# 2. Website (apps/website) - uses Bloom API
# 3. Database Migrations (db/migrations)
#
# NOTE: Website API (apps/website/functions) has been removed - all functions consolidated into Bloom API
# NOTE: Halaxy Sync Worker has been disabled - data is fetched directly from Halaxy APIs
#
# ENVIRONMENTS:
# - Development (develop branch)
# - Staging (staging branch)
# - Production (main branch)
#
# TRIGGERS:
# - Auto-deploy on push to main/staging/develop
# - Smart change detection per app/db

name: CI/CD Pipeline

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
      - develop   # Development
  pull_request:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      deploy_bloom:
        description: 'Deploy Bloom Portal'
        required: false
        type: boolean
        default: true
      deploy_website:
        description: 'Deploy Website'
        required: false
        type: boolean
        default: true
      deploy_apis:
        description: 'Deploy APIs'
        required: false
        type: boolean
        default: true
      run_migrations:
        description: 'Run Database Migrations'
        required: false
        type: boolean
        default: true
      deploy_halaxy_sync:
        description: 'Deploy Halaxy Sync Service (DISABLED)'
        required: false
        type: boolean
        default: false
      dry_run_migrations:
        description: 'Dry run migrations (preview only)'
        required: false
        type: boolean
        default: false

# Ensure only one workflow runs per branch at a time
# Cancel any in-progress runs when a new push happens
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write

env:
  NODE_VERSION: '20'
  NODE_VERSION_API: '18'
  PNPM_VERSION: '9'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 1: SETUP & ENVIRONMENT CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Environment Configuration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  determine-environment:
    name: ğŸŒ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should-deploy: ${{ steps.config.outputs.should_deploy }}
      is-staging-validation: ${{ steps.config.outputs.is_staging_validation }}
      db-environment: ${{ steps.config.outputs.db_environment }}
      # Bloom Portal
      bloom-frontend-app: ${{ steps.config.outputs.bloom_frontend_app }}
      bloom-api-app: ${{ steps.config.outputs.bloom_api_app }}
      bloom-frontend-secret: ${{ steps.config.outputs.bloom_frontend_secret }}
      bloom-api-secret: ${{ steps.config.outputs.bloom_api_secret }}
      bloom-api-url: ${{ steps.config.outputs.bloom_api_url }}
      # Website
      website-frontend-app: ${{ steps.config.outputs.website_frontend_app }}
      website-frontend-secret: ${{ steps.config.outputs.website_frontend_secret }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          REF="${{ github.ref }}"
          MANUAL_ENV="${{ github.event.inputs.environment }}"

          echo "ğŸ“ Branch/Ref: $REF"
          echo "ğŸ¯ Manual Override: $MANUAL_ENV"

          # Use manual input if workflow_dispatch, otherwise use branch
          if [ -n "$MANUAL_ENV" ]; then
            ENV="$MANUAL_ENV"
          else
            case "$REF" in
              refs/heads/main)
                ENV="production"
                ;;
              refs/heads/staging)
                ENV="staging"
                ;;
              refs/heads/develop)
                ENV="development"
                ;;
              refs/pull/*)
                ENV="preview"
                ;;
              *)
                ENV="preview"
                ;;
            esac
          fi

          # Database environment mapping (staging uses dev DBs)
          IS_STAGING_VALIDATION="false"
          case "$ENV" in
            production)
              DB_ENV="prod"
              ;;
            staging)
              DB_ENV="dev"
              IS_STAGING_VALIDATION="true"
              ;;
            *)
              DB_ENV="dev"
              ;;
          esac

          # Set resource names based on environment
          case "$ENV" in
            production)
              BLOOM_FRONTEND_APP="lpa-bloom-prod"
              BLOOM_API_APP="bloom-platform-functions-v2"
              BLOOM_API_URL="https://bloom-platform-functions-v2.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_PROD"
              BLOOM_API_SECRET="BLOOM_PROD_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-prod"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_PROD"
              SHOULD_DEPLOY="true"
              ;;
            staging)
              BLOOM_FRONTEND_APP="lpa-bloom-staging"
              BLOOM_API_APP="bloom-functions-staging-new"
              BLOOM_API_URL="https://bloom-functions-staging-new.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_STAGING"
              BLOOM_API_SECRET="BLOOM_STAGING_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-staging"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_STAGING"
              SHOULD_DEPLOY="true"
              ;;
            development)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_BLOOM_DEV"
              BLOOM_API_SECRET="BLOOM_DEV_API_PUBLISH_PROFILE"
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_FRONTEND_SECRET="AZURE_STATIC_WEB_APPS_API_TOKEN_WEBSITE_DEV"
              SHOULD_DEPLOY="true"
              ;;
            preview)
              BLOOM_FRONTEND_APP="lpa-bloom-dev"
              BLOOM_API_APP="bloom-functions-dev"
              BLOOM_API_URL="https://bloom-functions-dev.azurewebsites.net/api"
              BLOOM_FRONTEND_SECRET=""
              BLOOM_API_SECRET=""
              WEBSITE_FRONTEND_APP="lpa-frontend-dev"
              WEBSITE_FRONTEND_SECRET=""
              SHOULD_DEPLOY="false"
              ;;
          esac

          # Output configuration
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_staging_validation=$IS_STAGING_VALIDATION" >> $GITHUB_OUTPUT
          echo "db_environment=$DB_ENV" >> $GITHUB_OUTPUT
          
          # Bloom Portal
          echo "bloom_frontend_app=$BLOOM_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_app=$BLOOM_API_APP" >> $GITHUB_OUTPUT
          echo "bloom_api_url=$BLOOM_API_URL" >> $GITHUB_OUTPUT
          echo "bloom_frontend_secret=$BLOOM_FRONTEND_SECRET" >> $GITHUB_OUTPUT
          echo "bloom_api_secret=$BLOOM_API_SECRET" >> $GITHUB_OUTPUT
          
          # Website
          echo "website_frontend_app=$WEBSITE_FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "website_frontend_secret=$WEBSITE_FRONTEND_SECRET" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ENVIRONMENT CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Environment:         $ENV"
          echo "ğŸ—„ï¸ DB Environment:      $DB_ENV"
          echo "ğŸš€ Should Deploy:       $SHOULD_DEPLOY"
          echo "ğŸ”„ Staging Validation:  $IS_STAGING_VALIDATION"
          echo ""
          echo "ğŸŒ¸ Bloom Frontend:      $BLOOM_FRONTEND_APP"
          echo "ğŸ”Œ Bloom API:           $BLOOM_API_APP"
          echo "ğŸŒ Website Frontend:    $WEBSITE_FRONTEND_APP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Quality Checks (Run in Parallel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint

  type-check:
    name: ğŸ” Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Type Check
        run: npx tsc --noEmit

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 2: DATABASE MIGRATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect Migration Changes
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  detect-migrations:
    name: ğŸ” Detect Migration Changes
    runs-on: ubuntu-latest
    outputs:
      has_migrations: ${{ steps.check.outputs.has_migrations }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for Migration Changes
        id: check
        run: |
          # For manual dispatch, use the input
          if [ "${{ github.event.inputs.run_migrations }}" == "true" ]; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… Migrations enabled via manual input"
            exit 0
          fi
          
          # For push events, check if migration files changed
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "^db/migrations/"; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… Migration files changed - will run migrations"
            git diff --name-only HEAD~1 HEAD | grep "^db/migrations/"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No migration file changes detected"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Validate Migrations
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  validate-migrations:
    name: âœ… Validate Migrations
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-migrations]
    if: needs.detect-migrations.outputs.has_migrations == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Build API
        working-directory: api
        run: npm run build

      - name: Validate Migration Scripts
        run: |
          echo "ğŸ” Validating migration scripts..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              echo "   Checking: $file"
              if grep -qi "DROP DATABASE" "$file"; then
                echo "âŒ Error: DROP DATABASE found in $file"
                exit 1
              fi
              if grep -qi "TRUNCATE.*applications" "$file" && [ "${{ needs.determine-environment.outputs.db-environment }}" == "prod" ]; then
                echo "âš ï¸ Warning: TRUNCATE on applications table in production"
              fi
            fi
          done
          
          echo "âœ… All migration scripts validated"

      - name: Check Migration Naming Convention
        run: |
          echo "ğŸ” Checking migration naming conventions..."
          
          for file in db/migrations/V*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if ! [[ "$filename" =~ ^V[0-9]+[a-z]?__[a-z0-9_]+\.sql$ ]]; then
                echo "âš ï¸ Warning: $filename doesn't follow naming convention V{version}__{description}.sql"
              fi
            fi
          done
          
          echo "âœ… Naming convention check complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Run Migrations
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  run-migrations:
    name: ğŸ—„ï¸ Run Flyway Migrations (${{ needs.determine-environment.outputs.db-environment }})
    runs-on: ubuntu-latest
    needs: [determine-environment, detect-migrations, validate-migrations, lint, type-check]
    if: |
      always() &&
      needs.detect-migrations.outputs.has_migrations == 'true' &&
      needs.validate-migrations.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.db-environment == 'prod' && 'production' || needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Database Connection from Key Vault
        id: db-config
        run: |
          ENV_SUFFIX="${{ needs.determine-environment.outputs.db-environment == 'prod' && 'PROD' || 'DEV' }}"
          KV_NAME="lpa-kv-dev-i3u6u6psuu75o"
          
          echo "ğŸ“¦ Environment: ${{ needs.determine-environment.outputs.db-environment }}"
          echo "ğŸ”‘ Fetching SQL-${ENV_SUFFIX}-CONNECTION-STRING from Key Vault..."
          
          CONN_STR=$(az keyvault secret show \
            --name "SQL-${ENV_SUFFIX}-CONNECTION-STRING" \
            --vault-name "$KV_NAME" \
            --query value -o tsv)
          
          if [ -z "$CONN_STR" ]; then
            echo "âŒ Could not retrieve connection string from Key Vault"
            exit 1
          fi
          
          # Parse connection string for Flyway JDBC URL
          # Handle both formats: Server=tcp:xxx,1433 and Server=xxx
          if echo "$CONN_STR" | grep -q "Server=tcp:"; then
            SERVER=$(echo "$CONN_STR" | sed -n 's/.*Server=tcp:\([^,;]*\).*/\1/p')
          else
            SERVER=$(echo "$CONN_STR" | sed -n 's/.*Server=\([^;,]*\).*/\1/p')
          fi
          
          # Handle both formats: Initial Catalog and Database
          if echo "$CONN_STR" | grep -qi "Initial Catalog"; then
            DATABASE=$(echo "$CONN_STR" | sed -n 's/.*Initial Catalog=\([^;]*\).*/\1/ip' | head -1)
          else
            DATABASE=$(echo "$CONN_STR" | sed -n 's/.*Database=\([^;]*\).*/\1/ip' | head -1)
          fi
          
          # Handle both formats: User ID and User Id
          USER=$(echo "$CONN_STR" | sed -n 's/.*User I[Dd]=\([^;]*\).*/\1/p' | head -1)
          
          # Handle both formats: Password and Pwd
          PASSWORD=$(echo "$CONN_STR" | sed -n 's/.*Password=\([^;]*\).*/\1/ip' | head -1)
          if [ -z "$PASSWORD" ]; then
            PASSWORD=$(echo "$CONN_STR" | sed -n 's/.*Pwd=\([^;]*\).*/\1/ip' | head -1)
          fi
          
          echo "::add-mask::$PASSWORD"
          
          # Build JDBC URL for SQL Server
          JDBC_URL="jdbc:sqlserver://${SERVER}:1433;database=${DATABASE};encrypt=true;trustServerCertificate=false;loginTimeout=30"
          
          echo "ğŸ—„ï¸ Database: $DATABASE"
          echo "ğŸ”— Server: $SERVER"
          
          echo "FLYWAY_URL=$JDBC_URL" >> $GITHUB_OUTPUT
          echo "FLYWAY_USER=$USER" >> $GITHUB_OUTPUT
          echo "FLYWAY_PASSWORD=$PASSWORD" >> $GITHUB_OUTPUT
          echo "DB_NAME=$DATABASE" >> $GITHUB_OUTPUT

      - name: Flyway Info (Pre-migration)
        uses: docker://flyway/flyway:10
        with:
          args: >-
            -url="${{ steps.db-config.outputs.FLYWAY_URL }}"
            -user="${{ steps.db-config.outputs.FLYWAY_USER }}"
            -password="${{ steps.db-config.outputs.FLYWAY_PASSWORD }}"
            -locations="filesystem:./db/migrations"
            -table=flyway_schema_history
            -baselineOnMigrate=true
            -baselineVersion=0
            info

      - name: Flyway Validate
        id: validate
        uses: docker://flyway/flyway:10
        with:
          args: >-
            -url="${{ steps.db-config.outputs.FLYWAY_URL }}"
            -user="${{ steps.db-config.outputs.FLYWAY_USER }}"
            -password="${{ steps.db-config.outputs.FLYWAY_PASSWORD }}"
            -locations="filesystem:./db/migrations"
            -table=flyway_schema_history
            -baselineOnMigrate=true
            -baselineVersion=0
            validate
        continue-on-error: true

      - name: Flyway Migrate
        id: migrate
        uses: docker://flyway/flyway:10
        with:
          args: >-
            -url="${{ steps.db-config.outputs.FLYWAY_URL }}"
            -user="${{ steps.db-config.outputs.FLYWAY_USER }}"
            -password="${{ steps.db-config.outputs.FLYWAY_PASSWORD }}"
            -locations="filesystem:./db/migrations"
            -table=flyway_schema_history
            -baselineOnMigrate=true
            -baselineVersion=0
            -mixed=true
            -outOfOrder=false
            -validateMigrationNaming=true
            migrate

      - name: Flyway Info (Post-migration)
        if: success()
        uses: docker://flyway/flyway:10
        with:
          args: >-
            -url="${{ steps.db-config.outputs.FLYWAY_URL }}"
            -user="${{ steps.db-config.outputs.FLYWAY_USER }}"
            -password="${{ steps.db-config.outputs.FLYWAY_PASSWORD }}"
            -locations="filesystem:./db/migrations"
            -table=flyway_schema_history
            info

      - name: Migration Summary
        if: always()
        run: |
          echo "## ğŸ—„ï¸ Flyway Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.determine-environment.outputs.db-environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | \`${{ steps.db-config.outputs.DB_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | \`${{ steps.validate.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Migration | \`${{ steps.migrate.outcome }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Rollback on Failure (Production only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  rollback-migrations:
    name: ğŸ”„ Rollback Migrations (if needed)
    runs-on: ubuntu-latest
    needs: [determine-environment, run-migrations]
    if: |
      failure() && 
      needs.determine-environment.outputs.db-environment == 'prod' && 
      github.event.inputs.dry_run_migrations != 'true' &&
      github.event_name != 'pull_request'
    environment: production
    steps:
      - name: Rollback Alert
        run: |
          echo "âš ï¸ Production migration failed!"
          echo "Manual rollback may be required."

      - name: Create Issue for Failed Migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Production Migration Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Migration Failure
              
              A database migration failed in production.
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Commit:** ${context.sha}
              
              /cc @${context.actor}
              `,
              labels: ['bug', 'production', 'database', 'urgent']
            });

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 3: BUILD APPLICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-frontend:
    name: ğŸŒ¸ Build Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Bloom Application
        env:
          # Map environment to Vite mode - staging uses .env.staging, production uses .env.production
          MODE: ${{ needs.determine-environment.outputs.environment }}
          VITE_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
        run: |
          echo "ğŸŒ¸ Building Bloom Frontend..."
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“¦ Using Vite mode: $MODE"
          npm run build:bloom -- --mode $MODE
          echo "âœ… Build complete"

      - name: Verify Build Output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ dist/index.html not found!"
            exit 1
          fi
          echo "âœ… Build verified"

      - name: Package Artifacts
        run: |
          tar -czf bloom-frontend-dist.tar.gz dist
          sha256sum bloom-frontend-dist.tar.gz > bloom-frontend-dist.tar.gz.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: |
            bloom-frontend-dist.tar.gz
            bloom-frontend-dist.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-website-frontend:
    name: ğŸŒ Build Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Website Dependencies
        working-directory: apps/website
        run: npm install

      - name: Build Website Application
        run: |
          echo "ğŸŒ Building Website Frontend..."
          npm run build:website
          echo "âœ… Build complete"
        env:
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_API_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
          VITE_FUNCTIONS_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
          VITE_AZURE_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}
          VITE_AVAILABILITY_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/halaxy/availability
          VITE_HALAXY_BOOKING_FUNCTION_URL: ${{ needs.determine-environment.outputs.bloom-api-url }}/create-halaxy-booking

      - name: Verify Build Output
        run: |
          if [ ! -f "apps/website/dist/index.html" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          echo "âœ… Build verified"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: apps/website/dist/
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-bloom-api:
    name: ğŸ”Œ Build Bloom API (incl. Halaxy Sync)
    runs-on: ubuntu-latest
    needs: [determine-environment, lint, type-check]
    if: |
      always() &&
      needs.determine-environment.outputs.should-deploy == 'true' &&
      needs.lint.result == 'success' &&
      needs.type-check.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION_API }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install API Dependencies
        working-directory: ./api
        run: npm ci

      - name: Build Bloom API
        working-directory: ./api
        run: |
          echo "ğŸ”Œ Building Bloom API..."
          npm run build
          echo "âœ… API build complete"

      - name: Verify Halaxy Sync Service
        working-directory: ./api
        run: |
          echo "ğŸ”„ Verifying Halaxy Sync Service compilation..."
          if [ -f "dist/services/halaxy/sync-service.js" ]; then
            echo "âœ… Halaxy Sync Service compiled successfully"
          else
            echo "âŒ Halaxy Sync Service not found in build output!"
            exit 1
          fi
          
          # Verify all Halaxy service files
          for file in client index transformers token-manager types; do
            if [ -f "dist/services/halaxy/${file}.js" ]; then
              echo "  âœ“ halaxy/${file}.js"
            else
              echo "  âœ— halaxy/${file}.js MISSING"
              exit 1
            fi
          done
          
          echo "âœ… All Halaxy Sync Service modules verified"

      - name: Verify Build Output
        working-directory: ./api
        run: |
          echo "ğŸ” Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist/ folder not found!"
            exit 1
          fi
          
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ dist/index.js not found!"
            exit 1
          fi
          
          if [ ! -d "dist/functions" ]; then
            echo "âŒ dist/functions/ folder not found!"
            exit 1
          fi
          
          echo "ğŸ“ dist/ contents:"
          ls -la dist/
          echo "ğŸ“ dist/functions/ contents:"
          ls -la dist/functions/
          
          # Count functions
          FUNC_COUNT=$(ls -1 dist/functions/*.js 2>/dev/null | wc -l)
          echo "âœ… Found ${FUNC_COUNT} function files"
          
          if [ "$FUNC_COUNT" -eq 0 ]; then
            echo "âŒ No function .js files found in dist/functions/"
            exit 1
          fi

      - name: Package Bloom API
        working-directory: ./api
        run: |
          echo "ğŸ“¦ Creating deploy package..."
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copy compiled output
          cp -r dist/* deploy-package/
          
          # Copy required config files
          cp host.json deploy-package/
          cp package.json deploy-package/
          
          # Update package.json main entry point
          cd deploy-package
          sed -i 's|"main": "dist/index.js"|"main": "index.js"|' package.json
          
          # Install production dependencies
          npm install --production
          
          # Verify package contents
          echo "ğŸ“ deploy-package/ contents:"
          ls -la
          echo "ğŸ“ deploy-package/functions/ contents:"
          ls -la functions/
          
          echo "âœ… Package ready"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: api/deploy-package/**
          if-no-files-found: error
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Halaxy Sync Worker (Container Apps) - DISABLED
  # Note: Halaxy data is fetched directly from APIs at request time
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-halaxy-worker:
    name: ğŸ³ Build Halaxy Sync Worker (DISABLED)
    runs-on: ubuntu-latest
    needs: [determine-environment]
    if: false  # DISABLED - Halaxy data fetched directly from APIs
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Skip Notice
        run: echo "Halaxy Sync Worker is disabled - data fetched directly from APIs"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 4: DEPLOY TO AZURE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-frontend:
    name: ğŸš€ Deploy Bloom Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-frontend]
    if: |
      always() &&
      needs.build-bloom-frontend.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-frontend-${{ needs.determine-environment.outputs.environment }}
          path: artifact-download

      - name: Verify and Extract Artifacts
        run: |
          cd artifact-download
          sha256sum -c bloom-frontend-dist.tar.gz.sha256
          tar -xzf bloom-frontend-dist.tar.gz
          cp -r dist ../dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.bloom-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "âœ… BLOOM FRONTEND DEPLOYED"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ”— URL: https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Website Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-website-frontend:
    name: ğŸš€ Deploy Website Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build-website-frontend]
    if: |
      always() &&
      needs.build-website-frontend.result == 'success' &&
      needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-frontend-${{ needs.determine-environment.outputs.environment }}
          path: dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[needs.determine-environment.outputs.website-frontend-secret] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Summary
        run: |
          echo "âœ… WEBSITE FRONTEND DEPLOYED"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ”— URL: https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Bloom API
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-bloom-api:
    name: ğŸš€ Deploy Bloom API
    runs-on: ubuntu-latest
    needs: [determine-environment, build-bloom-api]
    if: |
      always() &&
      needs.build-bloom-api.result == 'success'
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-api-${{ needs.determine-environment.outputs.environment }}
          path: bloom-api-dist

      - name: Check Publish Profile
        id: check-secret
        run: |
          if [ -z "${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}" ]; then
            echo "secret-exists=false" >> $GITHUB_OUTPUT
          else
            echo "secret-exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure Functions
        if: steps.check-secret.outputs.secret-exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.determine-environment.outputs.bloom-api-app }}
          package: bloom-api-dist
          publish-profile: ${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}

      - name: Sync Function Triggers
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "ğŸ”„ Waiting for deployment to settle..."
          sleep 15
          
          # Extract credentials from publish profile
          PUBLISH_PROFILE='${{ secrets[needs.determine-environment.outputs.bloom-api-secret] }}'
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | sed 's/userName="//')
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | sed 's/userPWD="//')
          
          echo "ğŸ”„ Triggering function sync..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/functions/synctriggers" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 60 || echo "âš ï¸ Sync trigger request completed (may have timed out)"
          
          echo "ğŸ”„ Restarting function app to ensure functions are loaded..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.scm.azurewebsites.net/api/restart" \
            -u "${USERNAME}:${PASSWORD}" \
            --silent --show-error --max-time 30 || echo "âš ï¸ Restart request sent"
          
          sleep 10
          echo "âœ… Function sync and restart complete"

      - name: Trigger Halaxy Sync
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "ğŸ”„ Waiting for function app to be fully ready..."
          sleep 20
          
          echo "ğŸ”„ Triggering Halaxy sync to populate availability data..."
          curl -X POST "https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net/api/halaxy/sync" \
            -H "Content-Type: application/json" \
            --silent --show-error --max-time 120 \
            -w "\nğŸ“Š HTTP Status: %{http_code}\n" || echo "âš ï¸ Sync trigger request completed"
          
          echo "âœ… Halaxy sync triggered successfully"

      - name: Deployment Summary
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "âœ… BLOOM API DEPLOYED"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ”— URL: https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "ğŸ”„ Halaxy Sync: Triggered automatically"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Halaxy Sync Worker (Container Apps) - DISABLED
  # Note: Halaxy data is fetched directly from APIs at request time
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  deploy-halaxy-worker:
    name: ğŸ³ Deploy Halaxy Sync Worker (DISABLED)
    runs-on: ubuntu-latest
    needs: [determine-environment]
    if: false  # DISABLED - Halaxy data fetched directly from APIs
    steps:
      - name: Skip Notice
        run: echo "Halaxy Sync Worker deployment is disabled - data fetched directly from APIs"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STAGE 5: DEPLOYMENT SUMMARY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - run-migrations
      - deploy-bloom-frontend
      - deploy-bloom-api
      - deploy-website-frontend
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸŒ¸ LIFE PSYCHOLOGY DEPLOYMENT SUMMARY ğŸŒ¸               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Environment:     ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ“… Date:            $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”– Commit:          ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by:    ${{ github.actor }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "DEPLOYMENT STATUS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ—„ï¸ Migrations:      ${{ needs.run-migrations.result }}"
          echo "ğŸŒ¸ Bloom Frontend:  ${{ needs.deploy-bloom-frontend.result }}"
          echo "ğŸ”Œ Bloom API:       ${{ needs.deploy-bloom-api.result }}"
          echo "ğŸŒ Website Frontend: ${{ needs.deploy-website-frontend.result }}"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "APPLICATION URLS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸŒ¸ Bloom Portal:    https://${{ needs.determine-environment.outputs.bloom-frontend-app }}.azurestaticapps.net"
          echo "ğŸ”Œ Bloom API:       https://${{ needs.determine-environment.outputs.bloom-api-app }}.azurewebsites.net"
          echo "ğŸŒ Website:         https://${{ needs.determine-environment.outputs.website-frontend-app }}.azurestaticapps.net"
          echo ""

          # Check for failures (skipped is OK)
          MIGRATIONS="${{ needs.run-migrations.result }}"
          BLOOM_FE="${{ needs.deploy-bloom-frontend.result }}"
          BLOOM_API="${{ needs.deploy-bloom-api.result }}"
          WEBSITE_FE="${{ needs.deploy-website-frontend.result }}"
          
          if [[ "$MIGRATIONS" == "failure" ]] || [[ "$BLOOM_FE" == "failure" ]] || \
             [[ "$BLOOM_API" == "failure" ]] || [[ "$WEBSITE_FE" == "failure" ]]; then
            echo "âŒ DEPLOYMENT FAILED - See logs above"
            exit 1
          else
            echo "âœ… DEPLOYMENT SUCCESSFUL"
          fi
